/**
 * ×§×•×“ Google Apps Script ×œ×¡× ×›×¨×•×Ÿ ×“×•-×›×™×•×•× ×™ ×¢× ×ª×•×›× ×ª ×§××¤×™×™×Ÿ ×¤×•×¨×™×
 * ×›×•×œ×œ ×—×™×‘×•×¨ ×××•×‘×˜×— ×œ× ×“×¨×™× ×¤×œ×•×¡
 * 
 * ========== ×”×•×¨××•×ª ×”×ª×§× ×” ==========
 * 
 * 1. ×¤×ª×— ××ª ×”×’×œ×™×•×Ÿ ×”××œ×§×˜×¨×•× ×™ ×©×œ×š ×‘×’×•×’×œ
 * 2. ×œ×—×¥ ×¢×œ "×”×¨×—×‘×•×ª" (Extensions) -> "Apps Script"
 * 3. ××—×§ ××ª ×›×œ ×”×§×•×“ ×©×™×© ×©× ×•×”×“×‘×§ ××ª ×”×§×•×“ ×”×–×” ×‘××§×•×
 * 4. ×©× ×” ××ª SPREADSHEET_ID ×œ××–×”×” ×©×œ ×”×’×œ×™×•×Ÿ ×©×œ×š (××•×¤×™×¢ ×‘-URL)
 * 5. ×”×’×“×¨ ×¡×•×“×•×ª × ×“×¨×™× ×¤×œ×•×¡ ×‘-Script Properties (×œ× ×‘×§×•×“!):
 *    ×”×¨×—×‘×•×ª â†’ Apps Script â†’ ×¤×¨×•×™×§×˜ â†’ ×”×’×“×¨×•×ª (×’×œ×’×œ) â†’ Script properties
 *    ×”×•×¡×£: NEDARIM_MOSAD_ID, NEDARIM_API_PASSWORD, NEDARIM_MATCHING_ID (××•×¤×¦×™×•× ×œ×™), NEDARIM_API_VALID (××•×¤×¦×™×•× ×œ×™ â€“ ×œ×”×˜××¢×ª iframe/×•×•×§×•××¨×¡)
 * 6. ×œ×—×¥ ×¢×œ "×¤×¨×™×¡×”" (Deploy) -> "×¤×¨×™×¡×” ×—×“×©×”" (New deployment) â€“ ×¨×§ ×‘×¤×¢× ×”×¨××©×•× ×”!
 * 7. ×‘×—×¨ ×¡×•×’: "××¤×œ×™×§×¦×™×™×ª ××™× ×˜×¨× ×˜"
 * 8. ×”×’×“×¨ "×”×¤×¢×œ ×›": ×× ×™ (Me) | "×œ××™ ×™×© ×’×™×©×”": ×›×œ ××—×“ (Anyone)
 * 9. ×œ×—×¥ "×¤×¨×•×¡" ×•×”×¢×ª×§ ××ª ×”-URL ×©××ª×§×‘×œ
 * 
 * âš ï¸ ×¢×“×›×•×Ÿ ×§×•×“ (××—×¨×™ ×©×™×© ×›×‘×¨ ×¤×¨×™×¡×”):
 *    ××œ ×ª×™×¦×•×¨ "×¤×¨×™×¡×” ×—×“×©×”" â€“ ×–×” ××©× ×” ××ª ×”×§×™×©×•×¨!
 *    ×‘××§×•×: ×¤×¨×™×¡×” â†’ × ×”×œ ×¤×¨×™×¡×•×ª â†’ ×œ×™×“ ×”×¤×¨×™×¡×” ×”×§×™×™××ª ×œ×—×¥ ×¢×œ ×”×¢×¤×¨×•×Ÿ (×¢×¨×™×›×”) â†’
 *    "×’×¨×¡×”" â†’ "×’×¨×¡×” ×—×“×©×”" â†’ ×¤×¨×•×¡.
 *    ×›×š ×”×§×™×©×•×¨ × ×©××¨ ×–×”×” ×•×”×ª×•×›× ×” ×ª××©×™×š ×œ×¢×‘×•×“.
 * 
 * =====================================
 */

// âš ï¸ ×©× ×” ××ª ×”××–×”×” ×”×–×” ×œ××–×”×” ×©×œ ×”×’×œ×™×•×Ÿ ×©×œ×š!
const SPREADSHEET_ID = '1YI6XQZObSP1vfhIVh9wXYtIufM20PFjIGGM9rB-_rc8';

// *****************************************************************************
// *** × ×“×¨×™× ×¤×œ×•×¡ - ×¡×•×“×•×ª ×¨×§ ×-Script Properties (×œ× ×œ×”×–×™×Ÿ ×›××Ÿ!) ***
// *****************************************************************************
var NEDARIM_CONFIG_URLS = {
  API_URL: 'https://matara.pro/nedarimplus/Reports/Manage3.aspx',
  ONLINE_API_URL: 'https://www.matara.pro/nedarimplus/online/Files/Manage.aspx',
  MATCH_PLUS_API_URL: 'https://www.matara.pro/nedarimplus/V6/MatchPlus.aspx'
};

function getNedarimConfig() {
  var p = PropertiesService.getScriptProperties();
  var mosadId = (p.getProperty('NEDARIM_MOSAD_ID') || '').trim();
  var matchingId = (p.getProperty('NEDARIM_MATCHING_ID') || '').trim();
  var apiPassword = (p.getProperty('NEDARIM_API_PASSWORD') || '').trim();
  var apiValid = (p.getProperty('NEDARIM_API_VALID') || '').trim();
  return {
    MOSAD_ID: mosadId || '1000642',
    MATCHING_ID: matchingId || '715',
    API_PASSWORD: apiPassword || 'ep348',
    API_VALID: apiValid || 'wUF4j38+f+', // ×§×•×“ ××™××•×ª iframe/×•×•×§×•××¨×¡ â€“ ×œ×©×™××•×© ×‘×”×˜××¢×ª ×˜×•×¤×¡ ×ª×¨×•××” ×‘××ª×¨
    API_URL: NEDARIM_CONFIG_URLS.API_URL,
    ONLINE_API_URL: NEDARIM_CONFIG_URLS.ONLINE_API_URL,
    MATCH_PLUS_API_URL: NEDARIM_CONFIG_URLS.MATCH_PLUS_API_URL
  };
}

// ×©××•×ª ×”×’×™×œ×™×•× ×•×ª
const SHEET_NAMES = {
  DONORS: '××ª×¨×™××™×',
  GROUPS: '×§×‘×•×¦×•×ª',
  SETTINGS: '×”×’×“×¨×•×ª',
  ADDRESSES: '×›×ª×•×‘×•×ª',
  SCOUTS: '×¡×™×™×¨×•×ª',
  HISTORY: '×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª'
};

// ========== ××‘× ×” ×¢××•×“×•×ª ×¤×©×•×˜ ×•×‘×¨×•×¨ ==========
// ×¢××•×“×•×ª ×œ××ª×¨×™××™×
const DONOR_COLUMNS = [
  'id',              // ××–×”×” ×™×™×—×•×“×™
  'name',            // ×©× ××œ× (××§×•×¨×™)
  'displayName',     // ×©× ×ª×¦×•×’×” (××¤×©×¨ ×œ×¢×¨×•×š)
  'groupId',         // ××–×”×” ×§×‘×•×¦×”
  'groupName',       // ×©× ×”×§×‘×•×¦×” (×œ× ×•×—×•×ª)
  'amount',          // ×¡×›×•× ×©×’×•×™×¡
  'personalGoal',    // ×™×¢×“ ××™×©×™
  'source',          // ××§×•×¨: nedarim_plus / manual
  'nedarimMatrimId', // ××¡×¤×¨ ××ª×¨×™× ×‘× ×“×¨×™× ×¤×œ×•×¡
  'createdAt',       // ×ª××¨×™×š ×™×¦×™×¨×”
  'updatedAt'        // ×ª××¨×™×š ×¢×“×›×•×Ÿ
];

// ×¢××•×“×•×ª ×œ×§×‘×•×¦×•×ª
const GROUP_COLUMNS = [
  'id',              // ××–×”×” ×™×™×—×•×“×™
  'name',            // ×©× ×”×§×‘×•×¦×”
  'goal',            // ×™×¢×“ ×”×§×‘×•×¦×”
  'orderNumber',     // ×¡×“×¨ ×‘×ª×¦×•×’×”
  'showInLiveView',  // ×”×× ×œ×”×¦×™×’ ×‘×œ×™×™×‘
  'createdAt',       // ×ª××¨×™×š ×™×¦×™×¨×”
  'updatedAt'        // ×ª××¨×™×š ×¢×“×›×•×Ÿ
];

// ×¢××•×“×•×ª ×œ×›×ª×•×‘×•×ª
const ADDRESS_COLUMNS = [
  'id',              // ××–×”×” ×™×™×—×•×“×™
  'city',            // ×¢×™×¨
  'street',          // ×¨×—×•×‘ ×•××¡×¤×¨ ×‘×™×ª
  'date',            // ×ª××¨×™×š
  'amount',          // ×¡×›×•× ×ª×¨×•××”
  'whoBroughtMoney', // ××™ ×”×‘×™× ××ª ×”×›×¡×£
  'discrete',        // ×“×™×¡×§×¨×˜×™: ×›×Ÿ / ×œ× / ×œ× ××©× ×” ×œ×™
  'family',          // ××™×–×” ××©×¤×—×”
  'recruiterName',   // ××™ ×”××ª×¨×™× ×©×”×‘×™× ××ª ×”×›×ª×•×‘×ª
  'dateType',        // ×‘××™×–×” ×ª××¨×™×š: ×‘×™×´×“ / ×‘×˜×´×• / ××—×¨
  'timeOfDay',       // ×‘×•×§×¨ / ×¦×”×¨×™×™×
  'notes',           // ×”×¢×¨×•×ª
  'createdAt'        // ×ª××¨×™×š ×™×¦×™×¨×”
];

// ×¢××•×“×•×ª ×œ×¡×™×™×¨×•×ª (×¡×™×¨×ª ×©×˜×— = ×©×•×¨×” ××—×ª)
const SCOUT_COLUMNS = [
  'day',             // ×™×•×: day14, day15 ×•×›×•'
  'teamId',          // ××–×”×” ×¡×™×¨×ª
  'teamName',        // ×©× ×”×¡×™×¨×ª
  'city',            // ×¢×™×¨ ×™×¢×“
  'leader',          // ×¨××© ×¡×™×¨×ª
  'manualTotal',     // ×¡×›×•× ×™×“× ×™ (×× ×”×•×’×“×¨)
  'membersJson'      // JSON ×©×œ ×¨×©×™××ª ××ª×¨×™××™×: [{name, amount},...]
];

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª HTTP ×¨××©×™×•×ª ***
// *****************************************************************************

/** ××¢×˜×¤×ª ×‘×˜×•×—×” â€“ ××‘×˜×™×—×” ×ª××™×“ ×ª×’×•×‘×ª JSON ×ª×§×™× ×” (×œ×× ×™×¢×ª ×©×’×™××•×ª CORS) */
function safeJsonResponse(output) {
  try {
    var json = typeof output === 'object' && output !== null ? JSON.stringify(output) : JSON.stringify({ success: false, error: '×ª×’×•×‘×” ×œ× ×ª×§×™× ×”' });
    return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log('×©×’×™××” ×‘-safeJsonResponse: ' + err.toString());
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: err.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

/** ×ª×¨×’×•× ×©×’×™××ª ×§×•×˜×” ×œ×”×•×“×¢×” ×‘×¨×•×¨×” ×œ××©×ª××© */
function translateQuotaError(errMsg) {
  if (!errMsg || typeof errMsg !== 'string') return errMsg;
  if (errMsg.indexOf('urlfetch') >= 0 || errMsg.indexOf('Service invoked too many times') >= 0) {
    return '× ×’××¨×” ××›×¡×ª ×”×‘×§×©×•×ª ×”×™×•××™×ª ×©×œ Google. × ×¡×” ×©×•×‘ ××—×¨, ××• ×”×¤×—×ª ××ª ×ª×“×™×¨×•×ª ×”×¡× ×›×¨×•×Ÿ.';
  }
  return errMsg;
}

function doGet(e) {
  var output;
  
  try {
    // ×ª××™×›×” ×’× ×‘-Action (××•×ª ×’×“×•×œ×”) â€“ ×—×œ×§ ××”×œ×§×•×—×•×ª ×©×•×œ×—×™× ×›×š. ×’×–×™×¨×” ×›×“×™ ×œ×× ×•×¢ ×¨×•×•×—×™×/×ª×•×•×™× × ×¡×ª×¨×™×
    var rawAction = (e && e.parameter) ? (e.parameter.action || e.parameter.Action || '') : '';
    var action = (typeof rawAction === 'string' ? rawAction : String(rawAction || '')).trim();
    var params = e && e.parameter ? e.parameter : {};
    
    switch(action) {
      // ×‘×“×™×§×ª ×—×™×‘×•×¨
      case 'ping':
        output = { success: true, message: '×”×—×™×‘×•×¨ ×ª×§×™×Ÿ', timestamp: new Date().toISOString() };
        break;
        
      // ×¤×¢×•×œ×•×ª × ×“×¨×™× ×¤×œ×•×¡
      case 'getNedarimTotal': {
        var lightTotal = params.light === 'true' || params.light === '1';
        output = getNedarimTotalDonations(lightTotal);
        if (output && output.success === false && output.error) {
          output.error = translateQuotaError(output.error);
        }
        break;
      }
      case 'searchNedarimRecruiters':
        var searchTerm = params.search || '';
        output = searchNedarimRecruiters(searchTerm);
        if (output && output.success === false && output.error) {
          output.error = translateQuotaError(output.error);
        }
        break;
      case 'getAllNedarimRecruiters': {
        var light = params.light === 'true' || params.light === '1';
        var offset = parseInt(params.offset || 0, 10) || 0;
        var limit = parseInt(params.limit || 500, 10) || 500;
        if (limit > 500) limit = 500;
        output = getAllNedarimRecruiters(light);
        if (output && output.success && output.recruiters && output.recruiters.length > 0) {
          var start = Math.max(0, offset);
          var end = Math.min(output.recruiters.length, offset + limit);
          output.recruiters = output.recruiters.slice(start, end);
        }
        if (output && output.success === false && output.error) {
          output.error = translateQuotaError(output.error);
        }
        break;
      }
      case 'getPublicConfig': {
        var c = getNedarimConfig();
        output = { success: true, mosadId: c.MOSAD_ID, matchingId: c.MATCHING_ID };
        break;
      }
      // ×¢×“×›×•×Ÿ ×¡×›×•× ×‘× ×“×¨×™× ×¤×œ×•×¡ â€“ ×’× ×‘-GET ×›×“×™ ×œ×× ×•×¢ CORS preflight ×›×©×§×•×¨××™× ××”×“×¤×“×¤×Ÿ
      case 'updateNedarimAmount': {
        var req = {
          matrimId: (params.matrimId || '').toString().trim(),
          amount: params.amount != null ? params.amount : 0,
          clientName: (params.clientName || '×ª×•×¨× ×× ×•× ×™××™').toString().trim(),
          comments: (params.comments || '').toString().trim()
        };
        output = updateNedarimAmount(req);
        break;
      }
      // ×ª××™××•×ª ×œ×œ×§×•×—: ×”×œ×§×•×— ×©×•×œ×— action=ShowGoal&matchingId=... ×•××¦×¤×” ×œ-Donated, Goal (×›××• API ×©×œ × ×“×¨×™× ×¤×œ×•×¡)
      case 'ShowGoal': {
        var lightShowGoal = params.light === 'true' || params.light === '1';
        var totalResult = getNedarimTotalDonations(lightShowGoal);
        if (totalResult && totalResult.success === true) {
          output = {
            Donated: totalResult.totalDonated != null ? totalResult.totalDonated : 0,
            Goal: totalResult.goal != null ? totalResult.goal : 0
          };
        } else {
          output = {
            success: false,
            error: totalResult && totalResult.error ? translateQuotaError(totalResult.error) : '×œ× ×”×ª×§×‘×œ ×¡×›×•× ×-API'
          };
        }
        break;
      }
        
      // ×¤×¢×•×œ×•×ª ×¡× ×›×¨×•×Ÿ
      case 'getDonors':
        output = getAllDonors();
        break;
      case 'getGroups':
        output = getAllGroups();
        break;
      case 'getSettings':
        output = getAllSettings();
        break;
      case 'getAll':
        output = getAllData();
        break;
      case 'getAllNoDonors':
        output = getAllDataNoDonors();
        break;
      case 'syncNedarimFromSheet':
        output = syncNedarimFromSheet();
        break;
      case 'getAppLoginSettings':
        output = getAppLoginSettings();
        break;
      case 'getEntryCodeSettings':
        output = getEntryCodeSettings();
        break;
      case 'verifyEntryCode':
        output = verifyEntryCodeHandler(params.code);
        break;
      case 'getSimpleData':
        output = getAllData();
        break;
      case 'getHistory':
        output = getHistoryHandler(params);
        break;
        
      default:
        output = { success: false, error: '×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ' + action };
    }
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-doGet: ' + error.toString());
    output = { success: false, error: translateQuotaError(error.toString()) };
  }
  
  return safeJsonResponse(output);
}

function doPost(e) {
  var output;
  
  try {
    var requestData = {};
    
    if (e && e.postData && e.postData.contents) {
      try {
        requestData = JSON.parse(e.postData.contents);
      } catch (parseError) {
        return safeJsonResponse({ success: false, error: '×©×’×™××” ×‘×¤×¨×¡×•×¨ JSON' });
      }
    }
    
    var action = (requestData.action || '').toString().trim();
    
    switch(action) {
      // ×¤×¢×•×œ×•×ª × ×“×¨×™× ×¤×œ×•×¡ (×’× ×‘-POST â€“ ×™×¦×™×‘ ×™×•×ª×¨ ×-GET ×¢× query string)
      case 'getAllNedarimRecruiters': {
        var light = requestData.light === true || requestData.light === 'true' || requestData.light === '1';
        var offset = parseInt(requestData.offset || 0, 10) || 0;
        var limit = parseInt(requestData.limit || 500, 10) || 500;
        if (limit > 500) limit = 500;
        output = getAllNedarimRecruiters(light);
        if (output && output.success && output.recruiters && output.recruiters.length > 0) {
          var start = Math.max(0, offset);
          var end = Math.min(output.recruiters.length, offset + limit);
          output.recruiters = output.recruiters.slice(start, end);
        }
        if (output && output.success === false && output.error) {
          output.error = translateQuotaError(output.error);
        }
        break;
      }
      case 'getNedarimTotal': {
        var lightTotal = requestData.light === true || requestData.light === 'true' || requestData.light === '1';
        output = getNedarimTotalDonations(lightTotal);
        if (output && output.success === false && output.error) {
          output.error = translateQuotaError(output.error);
        }
        break;
      }
      case 'searchNedarimRecruiters':
        output = searchNedarimRecruiters((requestData.search || '').toString().trim());
        if (output && output.success === false && output.error) {
          output.error = translateQuotaError(output.error);
        }
        break;
      case 'getPublicConfig': {
        var c = getNedarimConfig();
        output = { success: true, mosadId: c.MOSAD_ID, matchingId: c.MATCHING_ID };
        break;
      }
      case 'ShowGoal': {
        var lightShowGoal = requestData.light === true || requestData.light === 'true' || requestData.light === '1';
        var totalResult = getNedarimTotalDonations(lightShowGoal);
        if (totalResult && totalResult.success === true) {
          output = {
            Donated: totalResult.totalDonated != null ? totalResult.totalDonated : 0,
            Goal: totalResult.goal != null ? totalResult.goal : 0
          };
        } else {
          output = {
            success: false,
            error: totalResult && totalResult.error ? translateQuotaError(totalResult.error) : '×œ× ×”×ª×§×‘×œ ×¡×›×•× ×-API'
          };
        }
        break;
      }
      case 'saveDonors':
        output = saveDonors(requestData.donors, requestData.groups);
        break;
      case 'saveGroups':
        output = saveGroups(requestData.groups);
        break;
      case 'saveSettings':
        output = saveSettings(requestData.settings);
        break;
      case 'saveAll':
      case 'syncAll':
        output = saveAllData(requestData);
        break;
      case 'updateNedarimAmount':
        // ×¢×“×›×•×Ÿ ×¡×›×•× ×‘× ×“×¨×™× ×¤×œ×•×¡ (×¨×§ ×¤×¨××˜×¨×™× ×‘×¡×™×¡×™×™×, ×œ×œ× MatchingId)
        output = updateNedarimAmount(requestData);
        break;
      case 'syncNedarimFromSheet':
        // ×¡× ×›×¨×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡ ××”×’×œ×™×•×Ÿ - ×§×•×¨× ××”×’×œ×™×•×Ÿ ×•××¢×“×›×Ÿ ××ª × ×“×¨×™× ×¤×œ×•×¡
        output = syncNedarimFromSheet();
        break;
      case 'storageSetItem':
        // ×©××™×¨×ª ×¢×¨×š ×‘-PropertiesService (×œ×©×™××•×© ×¢× storageSetItem)
        output = storageSetItemHandler(requestData.key, requestData.value);
        break;
      case 'storageGetItem':
        // ×˜×¢×™× ×ª ×¢×¨×š ×-PropertiesService (×œ×©×™××•×© ×¢× storageGetItem)
        output = storageGetItemHandler(requestData.key);
        break;
      case 'setAppLoginPassword':
        output = setAppLoginPasswordHandler(requestData.password, requestData.requireAppUnlock);
        break;
      case 'verifyAppLoginPassword':
        output = verifyAppLoginPasswordHandler(requestData.password);
        break;
      case 'verifyEntryCode':
        output = verifyEntryCodeHandler(requestData.code);
        break;
      case 'addHistory':
        output = addHistoryHandler(requestData.entry);
        break;
      default:
        output = { success: false, error: '×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ' + action };
    }
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-doPost: ' + error.toString());
    output = { success: false, error: translateQuotaError(error.toString()) };
  }
  
  return safeJsonResponse(output);
}

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª × ×“×¨×™× ×¤×œ×•×¡ ***
// *****************************************************************************

/** ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ â€“ ××¤×¢× ×—×ª ××¡×¤×¨ ×-JSON (××˜×¤×œ×ª ×‘××—×¨×•×–×•×ª ×¢× ×¤×¡×™×§×™×) */
function safeParseAmount(obj, keys) {
  for (var k = 0; k < keys.length; k++) {
    var v = obj[keys[k]];
    if (v === null || v === undefined) continue;
    var num = typeof v === 'number' ? v : parseFloat(String(v).replace(/[^\d.-]/g, ''));
    if (!isNaN(num) && isFinite(num)) return num;
  }
  return null;
}

/**
 * ×§×‘×œ×ª ×¡×›×•× ×ª×¨×•××•×ª ×›×•×œ×œ ×× ×“×¨×™× ×¤×œ×•×¡
 * @param {boolean} light - ×× true, ×¨×§ × ×™×¡×™×•× ×•×ª ××”×™×¨×™× â€“ ×‘×œ×™ ×œ×•×œ××ª ××•×ª×™×•×ª
 */
function getNedarimTotalDonations(light) {
  try {
    var cfg = getNedarimConfig();
    var totalFromRecruiters = 0;
    var goalFromAPI = 0;
    // × ×“×¨×™× ×¤×œ×•×¡ ShowGoal (MatchPlus) ××—×–×™×¨ total + goal â€“ ×—×™×™×‘×™× ×œ×›×œ×•×œ ×’× ××ª ×”×©××•×ª ×”××œ×”
    var donateKeys = ['total','Total','DSum','Donated','TotalDonated','DonatedAmount','dSum','donated'];
    var goalKeys = ['goal','Goal','TargetSum','GoalAmount','targetSum'];
    
    function extractFromResponse(data) {
      var tot = safeParseAmount(data, donateKeys);
      var goal = safeParseAmount(data, goalKeys);
      if (tot !== null && isFinite(tot)) return { total: tot, goal: goal || 0 };
      return null;
    }
    
    // × ×™×¡×™×•×Ÿ 0: MatchPlus ShowGoal â€“ ××§×•×¨ ×”×××ª (×›××• ×‘×™×•××Ÿ × ×“×¨×™×: ShowGoal (MatchPlus): total=..., goal=...)
    try {
      var matchUrls = [
        cfg.MATCH_PLUS_API_URL + '?Action=ShowGoal&MosadId=' + cfg.MOSAD_ID + '&GoalId=' + cfg.MATCHING_ID,
        cfg.MATCH_PLUS_API_URL + '?Action=ShowGoal&MosadId=' + cfg.MOSAD_ID + '&MatchingId=' + cfg.MATCHING_ID
      ];
      for (var mu = 0; mu < matchUrls.length; mu++) {
        var response1 = UrlFetchApp.fetch(matchUrls[mu], { method: 'GET', muteHttpExceptions: true });
        if (response1.getResponseCode() === 200) {
          var data = JSON.parse(response1.getContentText() || '{}');
          var extracted = extractFromResponse(data);
          if (extracted && extracted.total !== null && isFinite(extracted.total)) {
            Logger.log('ShowGoal (MatchPlus): total=' + extracted.total + ', goal=' + extracted.goal);
            return { success: true, totalDonated: extracted.total, goal: extracted.goal, source: 'ShowGoal-MatchPlus' };
          }
          goalFromAPI = extracted && extracted.goal ? extracted.goal : safeParseAmount(data, goalKeys) || 0;
          var donatedFromAPI = extracted && extracted.total !== null ? extracted.total : safeParseAmount(data, donateKeys);
          if (donatedFromAPI !== null && isFinite(donatedFromAPI)) {
            Logger.log('×¡×›×•× ×-API: ' + donatedFromAPI + ', ×™×¢×“: ' + goalFromAPI);
            return { success: true, totalDonated: donatedFromAPI, goal: goalFromAPI || 0, source: 'ShowGoal' };
          }
        }
      }
    } catch (e) {
      Logger.log('×©×’×™××” ×‘-ShowGoal (MatchPlus): ' + e.message);
    }
    
    // × ×™×¡×™×•×Ÿ 1: ONLINE_API_URL â€“ ×•×¨×™××¦×™×•×ª ×©×•× ×•×ª
    var onlineUrls = [
      cfg.ONLINE_API_URL + '?Action=ShowGoal&Ession=&S=1&Mosession=' + cfg.MATCHING_ID + '&MosadId=' + cfg.MOSAD_ID,
      cfg.ONLINE_API_URL + '?Action=ShowGoal&MatchingId=' + cfg.MATCHING_ID + '&MosadId=' + cfg.MOSAD_ID,
      cfg.ONLINE_API_URL + '?Action=ShowGoal&GoalId=' + cfg.MATCHING_ID + '&MosadId=' + cfg.MOSAD_ID
    ];
    for (var u = 0; u < onlineUrls.length; u++) {
      try {
        var resp = UrlFetchApp.fetch(onlineUrls[u], { method: 'GET', muteHttpExceptions: true });
        if (resp.getResponseCode() === 200) {
          var parsed = JSON.parse(resp.getContentText() || '{}');
          var extracted = extractFromResponse(parsed);
          if (extracted && extracted.total !== null && isFinite(extracted.total)) {
            Logger.log('ShowGoal (ONLINE): total=' + extracted.total + ', goal=' + extracted.goal);
            return { success: true, totalDonated: extracted.total, goal: extracted.goal, source: 'ShowGoal-Online' };
          }
        }
      } catch (e) {}
    }
    try {
      var url0b = cfg.ONLINE_API_URL + '?Action=GetMosad&MosadId=' + cfg.MOSAD_ID;
      var resp0b = UrlFetchApp.fetch(url0b, { method: 'GET', muteHttpExceptions: true });
      if (resp0b.getResponseCode() === 200) {
        var extracted = extractFromResponse(JSON.parse(resp0b.getContentText() || '{}'));
        if (extracted && extracted.total !== null && isFinite(extracted.total)) {
          Logger.log('GetMosad: total=' + extracted.total + ', goal=' + extracted.goal);
          return { success: true, totalDonated: extracted.total, goal: extracted.goal, source: 'GetMosad' };
        }
      }
    } catch (e) {}
    
    if (light) {
      Logger.log('××¦×‘ light â€“ ×“×™×œ×•×’ ×¢×œ ×œ×•×œ××ª ××•×ª×™×•×ª');
      return { success: false, error: '×œ× ×”×ª×§×‘×œ ×¡×›×•× ×-API (× ×™×¡×™×•×Ÿ ××”×™×¨ ×‘×œ×‘×“)', totalDonated: 0, goal: 0 };
    }
    
    // × ×™×¡×™×•×Ÿ 2: ×—×™×©×•×‘ ×”×¡×›×•× ×”×××™×ª×™ ××›×œ ×”××ª×¨×™××™×
    Logger.log('××—×©×‘ ×¡×›×•× ×›×•×œ×œ ××›×œ ×”××ª×¨×™××™×...');
    
    var hebrewLetters = ['×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×›', '×œ', '×', '× ', '×¡', '×¢', '×¤', '×¦', '×§', '×¨', '×©', '×ª'];
    var allRecruiters = {};
    
    // ×—×™×¤×•×© ×¨×™×§ ×§×•×“×
    try {
      var emptyResult = searchNedarimRecruiters('');
      if (emptyResult && emptyResult.success && emptyResult.recruiters) {
        emptyResult.recruiters.forEach(function(r) {
          var id = r.Id || r.MatrimId || r.Name;
          if (id) allRecruiters[id] = r;
        });
        Logger.log('×—×™×¤×•×© ×¨×™×§: ' + emptyResult.recruiters.length + ' ××ª×¨×™××™×');
      }
    } catch (e) {
      Logger.log('×©×’×™××” ×‘×—×™×¤×•×© ×¨×™×§: ' + e.message);
    }
    
    // ×—×™×¤×•×© ×œ×¤×™ ××•×ª×™×•×ª ×¢×‘×¨×™×•×ª
    for (var i = 0; i < hebrewLetters.length; i++) {
      var letter = hebrewLetters[i];
      try {
        var result = searchNedarimRecruiters(letter);
        if (result && result.success && result.recruiters) {
          result.recruiters.forEach(function(r) {
            var id = r.Id || r.MatrimId || r.Name;
            if (id) allRecruiters[id] = r;
          });
        }
      } catch (e) {
        Logger.log('×©×’×™××” ×‘×—×™×¤×•×© ' + letter + ': ' + e.message);
      }
    }
    
    // ×—×™×©×•×‘ ×”×¡×›×•× ×”×›×•×œ×œ
    var recruitersArray = [];
    for (var key in allRecruiters) {
      if (allRecruiters.hasOwnProperty(key)) {
        recruitersArray.push(allRecruiters[key]);
      }
    }
    
    for (var j = 0; j < recruitersArray.length; j++) {
      var r = recruitersArray[j];
      var amount = parseFloat(r.Cumule) || parseFloat(r.Amount) || parseFloat(r.Collected) || 0;
      totalFromRecruiters += amount;
    }
    
    Logger.log('×¡×›×•× ×›×•×œ×œ ×-' + recruitersArray.length + ' ××ª×¨×™××™×: ' + totalFromRecruiters);
    
    if (recruitersArray.length > 0) {
      return {
        success: true,
        totalDonated: totalFromRecruiters,
        goal: goalFromAPI,
        source: 'Calculated-FromAllRecruiters',
        recruitersCount: recruitersArray.length
      };
    }
    
    // Fallback: ×¡×›×•× ××”×’×™×œ×™×•×Ÿ ×¨×§ ×›×©-API × ×“×¨×™× ×œ× ×”×—×–×™×¨ ×›×œ×œ ××ª×¨×™××™×
    try {
      var donorsResult = getAllDonors();
      if (donorsResult.success && donorsResult.donors && donorsResult.donors.length > 0) {
        var sheetSum = 0;
        for (var d = 0; d < donorsResult.donors.length; d++) {
          sheetSum += parseFloat(donorsResult.donors[d].amount) || 0;
        }
        if (sheetSum >= 0) {
          Logger.log('Fallback: ×¡×›×•× ××”×’×™×œ×™×•×Ÿ = ' + sheetSum + ' (×-' + donorsResult.donors.length + ' ××ª×¨×™××™×)');
          return {
            success: true,
            totalDonated: sheetSum,
            goal: goalFromAPI || 500000,
            source: 'sheet_fallback'
          };
        }
      }
    } catch (sheetErr) {
      Logger.log('×©×’×™××” ×‘-fallback ××”×’×™×œ×™×•×Ÿ: ' + sheetErr.message);
    }
    
    return { success: false, error: '×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ × ×ª×•× ×™×', totalDonated: 0, goal: goalFromAPI };
    
  } catch (e) {
    Logger.log('×©×’×™××” ×›×œ×œ×™×ª: ' + e.message);
    return { success: false, error: e.message, totalDonated: 0, goal: 0 };
  }
}

/**
 * ×¢×“×›×•×Ÿ ×¡×›×•× ×‘× ×“×¨×™× ×¤×œ×•×¡ - ×¤×©×•×˜ ×•×™×©×™×¨
 * @param {Object} params - ×¤×¨××˜×¨×™×: matrimId (××¡×¤×¨ ××ª×¨×™×), amount (×©×™× ×•×™ ×‘×¡×›×•×), clientName, comments
 */
function updateNedarimAmount(params) {
  try {
    var cfg = getNedarimConfig();
    // ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
    if (!params.matrimId) {
      Logger.log('âŒ ×—×¡×¨ ××¡×¤×¨ ××ª×¨×™× (matrimId)');
      return { success: false, error: '×—×¡×¨ ××¡×¤×¨ ××ª×¨×™× (matrimId)' };
    }
    
    var validAmount = Math.round(parseFloat(params.amount) || 0);
    if (validAmount === 0) {
      Logger.log('âŒ ×¡×›×•× ×”×•× 0 - ×œ× ××¢×“×›×Ÿ');
      return { success: false, error: '×¡×›×•× ×—×™×™×‘ ×œ×”×™×•×ª ×©×•× ×” ×-0' };
    }
    
    // ×‘× ×™×™×ª ×¤×¨××˜×¨×™× ×œ×©×œ×™×—×” ×œ-API ×©×œ × ×“×¨×™× ×¤×œ×•×¡
    var formData = {
      'Action': 'MatchingOffLine',
      'MosadNumber': cfg.MOSAD_ID,
      'ApiPassword': cfg.API_PASSWORD,
      'MatrimId': String(params.matrimId), // ××¡×¤×¨ ××ª×¨×™× - ×–×” ×”××–×”×” ×”×™×—×™×“!
      'ClientName': (params.clientName || '×ª×•×¨× ×× ×•× ×™××™').trim(),
      'Amount': String(validAmount), // ×”×©×™× ×•×™ ×‘×¡×›×•× (×—×™×•×‘×™ ××• ×©×œ×™×œ×™)
      'Comments': (params.comments || '').trim(),
      'AjaxId': Date.now().toString()
    };
    
    Logger.log('ğŸ“¤ ×©×•×œ×— ×¢×“×›×•×Ÿ ×œ× ×“×¨×™× ×¤×œ×•×¡:', {
      MatrimId: formData.MatrimId,
      Amount: formData.Amount,
      MosadNumber: formData.MosadNumber,
      ClientName: formData.ClientName.substring(0, 30)
    });
    
    // ×©×œ×™×—×” ×œ-API ×©×œ × ×“×¨×™× ×¤×œ×•×¡
    var response = UrlFetchApp.fetch(cfg.API_URL, {
      method: 'POST',
      payload: formData,
      muteHttpExceptions: true
    });
    
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();
    
    Logger.log('ğŸ“¥ ×ª×’×•×‘×” ×× ×“×¨×™× ×¤×œ×•×¡:', {
      status: responseCode,
      responseLength: responseText.length,
      preview: responseText.substring(0, 200)
    });
    
    // ×× ×§×•×“ ×”×ª×’×•×‘×” ×”×•× 200, ×–×” ×”×¦×œ×—×”
    if (responseCode === 200) {
      // ×× ×¡×” ×œ×¤×¨×¡×¨ ×›-JSON
      try {
        var data = JSON.parse(responseText);
        if (data.Status === 'OK' || data.success === true) {
          Logger.log('âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×—:', data.Message || '×”×¡×›×•× ×¢×•×“×›×Ÿ');
          return { success: true, message: data.Message || '×”×¡×›×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' };
        }
        if (data.Status && data.Status !== 'OK') {
          Logger.log('âŒ ×©×’×™××” ×‘×ª×’×•×‘×”:', data.Message || data.error);
          return { success: false, error: data.Message || data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”' };
        }
        // ×× ××™×Ÿ Status ××‘×œ ×™×© JSON, ×–×” ×›× ×¨××” ×”×¦×œ×—×”
        Logger.log('âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×— (×œ×œ× Status):', responseText.substring(0, 100));
        return { success: true, message: '×”×¡×›×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' };
      } catch (parseError) {
        // ×× ×–×” ×œ× JSON, ×‘×•×“×§ ×× ×”×ª×’×•×‘×” ×§×¦×¨×” (×–×” ×‘×“×¨×š ×›×œ×œ ×”×¦×œ×—×”)
        var trimmed = responseText.trim();
        if (trimmed === '' || trimmed.length < 100) {
          Logger.log('âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×— (×ª×’×•×‘×” ×§×¦×¨×”):', trimmed);
          return { success: true, message: '×”×¡×›×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' };
        }
        // ×× ×”×ª×’×•×‘×” ××¨×•×›×”, ×–×” ×›× ×¨××” ×©×’×™××”
        Logger.log('âš ï¸ ×ª×’×•×‘×” ×œ× ×¦×¤×•×™×”:', trimmed.substring(0, 200));
        return { success: false, error: '×ª×’×•×‘×” ×œ× ×¦×¤×•×™×” ××”×©×¨×ª: ' + trimmed.substring(0, 150) };
      }
    } else {
      // ×§×•×“ ×œ× 200 = ×©×’×™××”
      Logger.log('âŒ ×©×’×™××ª ×©×¨×ª:', responseCode, responseText.substring(0, 200));
      return { 
        success: false, 
        error: '×©×’×™××ª ×©×¨×ª: ' + responseCode + ' - ' + responseText.substring(0, 150)
      };
    }
    
  } catch (err) {
    Logger.log('âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¢×“×›×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡: ' + err.toString());
    return { success: false, error: err.message || '×©×’×™××” ×œ× ×™×“×•×¢×”' };
  }
}

/**
 * ×¡× ×›×¨×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡ ××”×’×œ×™×•×Ÿ - ×§×•×¨× ××”×’×œ×™×•×Ÿ ×•××¢×“×›×Ÿ ××ª × ×“×¨×™× ×¤×œ×•×¡
 * ×¤×•× ×§×¦×™×” ×–×• ×§×•×¨××ª ××ª ×›×œ ×”××ª×¨×™× ××”×’×œ×™×•×Ÿ ×•××¢×“×›× ×ª ××ª × ×“×¨×™× ×¤×œ×•×¡ ×œ×¤×™ ××¡×¤×¨ ×”××ª×¨×™×
 */
function syncNedarimFromSheet() {
  try {
    Logger.log('ğŸ”„ ××ª×—×™×œ ×¡× ×›×¨×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡ ××”×’×œ×™×•×Ÿ...');
    
    // ×§×•×¨× ××ª ×›×œ ×”××ª×¨×™× ××”×’×œ×™×•×Ÿ
    var donorsResult = getAllDonors();
    if (!donorsResult.success || !donorsResult.donors || donorsResult.donors.length === 0) {
      Logger.log('âš ï¸ ××™×Ÿ ××ª×¨×™××™× ×‘×’×œ×™×•×Ÿ');
      return { success: false, error: '××™×Ÿ ××ª×¨×™××™× ×‘×’×œ×™×•×Ÿ' };
    }
    
    var donors = donorsResult.donors;
    Logger.log('ğŸ“¥ × ×˜×¢× ×• ' + donors.length + ' ××ª×¨×™××™× ××”×’×œ×™×•×Ÿ');
    
    // ××•×©×š ××ª ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×× ×“×¨×™× ×¤×œ×•×¡ ×›×“×™ ×œ×—×©×‘ ×“×œ×ª×•×ª
    var matrimList = [];
    try {
      var searchResult = searchNedarimRecruiters('');
      if (searchResult && searchResult.success && searchResult.recruiters) {
        matrimList = searchResult.recruiters;
        Logger.log('ğŸ“Š ×§×™×‘×œ× ×• ' + matrimList.length + ' ××ª×¨×™××™× ×× ×“×¨×™× ×¤×œ×•×¡ ×œ×”×©×•×•××”');
      }
    } catch (error) {
      Logger.log('âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ××©×•×š × ×ª×•× ×™× ×× ×“×¨×™× ×¤×œ×•×¡ ×œ×”×©×•×•××”: ' + error.message);
    }
    
    // ×× ××™×Ÿ ×¨×©×™××ª ××ª×¨×™××™× ×× ×“×¨×™× â€“ ×œ× ×©×•×œ×—×™× ×›×œ×•× (××•× ×¢ ×©×œ×™×—×ª ×¡×›×•× ××œ× ×‘××§×•× ×“×œ×ª×”)
    if (!matrimList || matrimList.length === 0) {
      Logger.log('âŒ ×œ× ×”×ª×§×‘×œ×” ×¨×©×™××ª ××ª×¨×™××™× ×× ×“×¨×™× ×¤×œ×•×¡ â€“ ×œ× × ×©×œ×— ×¢×“×›×•×Ÿ');
      return { success: false, error: '×œ× ×”×ª×§×‘×œ×” ×¨×©×™××ª ××ª×¨×™××™× ×× ×“×¨×™× ×¤×œ×•×¡. ×œ× × ×©×œ×— ×¢×“×›×•×Ÿ ×›×“×™ ×œ×× ×•×¢ ×˜×¢×•×™×•×ª.' };
    }
    
    // âš ï¸ ×—×©×•×‘: ×”×§×™×©×•×¨ ×”×•× ×œ×¤×™ ×”×©× ×‘×¢××•×“×” name (×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡), ×œ× ×œ×¤×™ ××¡×¤×¨ ××ª×¨×™×!
    // ×™×•×¦×¨ ××¤×” ×©×œ ×¡×›×•××™× ×× ×“×¨×™× ×¤×œ×•×¡ ×œ×¤×™ ×©× (×œ× ×œ×¤×™ ××¡×¤×¨ ××ª×¨×™×)
    var nedarimAmountsByNameMap = new Map();
    var nedarimMatrimIdsByNameMap = new Map(); // ××¤×” × ×•×¡×¤×ª ×œ××¡×¤×¨×™ ××ª×¨×™× ×œ×¤×™ ×©×
    matrimList.forEach(function(matrim) {
      var matrimName = (matrim.Name || matrim.name || '').trim();
      var matrimAmount = parseInt(matrim.Cumule) || parseInt(matrim.Amount) || 0;
      var matrimId = matrim.Id || matrim.MatrimId || matrim.id || null;
      if (matrimName) {
        nedarimAmountsByNameMap.set(matrimName, matrimAmount);
        if (matrimId !== null && matrimId !== undefined) {
          nedarimMatrimIdsByNameMap.set(matrimName, String(matrimId).trim());
        }
      }
    });
    
    // ××•×¦× ××ª×¨×™× ×©×™×© ×œ×”× ×©× ×•×”×¡×›×•× ×©×œ×”× ×©×•× ×” ×× ×“×¨×™× ×¤×œ×•×¡
    var donorsToUpdate = [];
    var updatedCount = 0;
    var skippedCount = 0;
    var failedCount = 0;
    var invalidMatrimIdCount = 0;
    
    for (var i = 0; i < donors.length; i++) {
      var donor = donors[i];
      
      // ×‘×•×“×§ ×× ×™×© ×©× (×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡)
      if (!donor.name) {
        skippedCount++;
        continue; // ××“×œ×’ ×¢×œ ××ª×¨×™× ×œ×œ× ×©×
      }
      
      var donorName = donor.name.trim(); // ×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡ (×¢××•×“×” name)
      var localAmount = donor.amount || 0;
      var nedarimAmount = nedarimAmountsByNameMap.get(donorName) || 0;
      var delta = localAmount - nedarimAmount;
      
      // ××•×¦× ××ª ××¡×¤×¨ ×”××ª×¨×™× ×œ×¤×™ ×”×©×
      var matrimIdStr = nedarimMatrimIdsByNameMap.get(donorName) || null;
      
      // ×× ××™×Ÿ ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ, ××“×œ×’
      if (!matrimIdStr || !/^\d+$/.test(matrimIdStr)) {
        invalidMatrimIdCount++;
        Logger.log('âš ï¸ ××ª×¨×™× ' + donorName + ' ×œ× × ××¦× ×œ×• ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ ×× ×“×¨×™× ×¤×œ×•×¡ - ××“×œ×’ ×¢×œ ×¢×“×›×•×Ÿ');
        skippedCount++;
        continue; // ××“×œ×’ ×¢×œ ××ª×¨×™× ×œ×œ× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ
      }
      
      // ×× ×™×© ×©×™× ×•×™, ××•×¡×™×£ ×œ×¨×©×™××” ×œ×¢×“×›×•×Ÿ
      if (Math.abs(delta) > 0) {
        donorsToUpdate.push({
          donor: donor,
          delta: delta,
          matrimId: matrimIdStr
        });
      } else {
        skippedCount++; // ××™×Ÿ ×©×™× ×•×™ - ××“×œ×’
      }
    }
    
    Logger.log('ğŸ“‹ × ××¦××• ' + donorsToUpdate.length + ' ××ª×¨×™××™× ×œ×¢×“×›×•×Ÿ ×‘× ×“×¨×™× ×¤×œ×•×¡');
    if (invalidMatrimIdCount > 0) {
      Logger.log('âš ï¸ ' + invalidMatrimIdCount + ' ××ª×¨×™××™× × ×“×œ×’×• ×›×™ ××™×Ÿ ×œ×”× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ');
    }
    
    // ××¢×“×›×Ÿ ×›×œ ××ª×¨×™× ×©×™×© ×œ×• ×©×™× ×•×™
    for (var j = 0; j < donorsToUpdate.length; j++) {
      var item = donorsToUpdate[j];
      var donor = item.donor;
      var delta = item.delta;
      var matrimId = item.matrimId;
      
      var donorName = donor.name || donor.displayName || '×ª×•×¨× ×× ×•× ×™××™';
      // ×§×•×¨× ××ª ×”×§×‘×•×¦×•×ª ××”×’×œ×™×•×Ÿ
      var groupsResult = getAllGroups();
      var groups = groupsResult.groups || [];
      var group = groups.find(function(g) { return g.id === donor.groupId; });
      var groupName = group ? group.name : '';
      var clientName = groupName ? donorName + ' - ' + groupName : donorName;
      
      Logger.log('ğŸ”„ ××¢×“×›×Ÿ ××ª×¨×™× ' + donorName + ' (××¡×¤×¨ ××ª×¨×™×: ' + matrimId + '): ×“×œ×ª×” = ' + delta);
      
      try {
        var updateResult = updateNedarimAmount({
          matrimId: matrimId,
          amount: delta,
          clientName: clientName,
          comments: '×¢×“×›×•×Ÿ ××”×’×œ×™×•×Ÿ - ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™ (×§×™×©×•×¨ ×œ×¤×™ ×©×)'
        });
        
        if (updateResult && updateResult.success) {
          updatedCount++;
          Logger.log('âœ… ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”: ' + donorName + ' (××¡×¤×¨ ××ª×¨×™×: ' + matrimId + ')');
        } else {
          failedCount++;
          Logger.log('âŒ × ×›×©×œ: ' + donorName + ' (××¡×¤×¨ ××ª×¨×™×: ' + matrimId + ') - ' + (updateResult.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
        }
        
        // ×××ª×™×Ÿ ×§×¦×ª ×‘×™×Ÿ ×¢×“×›×•× ×™× ×›×“×™ ×œ× ×œ×”×¢××™×¡ ×¢×œ ×”×©×¨×ª
        Utilities.sleep(500);
      } catch (error) {
        failedCount++;
        Logger.log('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ' + donorName + ': ' + error.message);
      }
    }
    
    // ×©×•××¨ ××ª ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ (×¢× ××¡×¤×¨×™ ×”××ª×¨×™× ×”××¢×•×“×›× ×™×)
    if (donorsToUpdate.length > 0) {
      try {
        var groupsResult = getAllGroups();
        var groups = groupsResult.groups || [];
        var saveResult = saveDonors(donors, groups);
        if (saveResult && saveResult.success) {
          Logger.log('âœ… × ×©××¨×• ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ');
        } else {
          Logger.log('âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ×©××•×¨ ××ª ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ: ' + (saveResult.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
        }
      } catch (error) {
        Logger.log('âš ï¸ ×©×’×™××” ×‘×©××™×¨×ª ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ: ' + error.message);
      }
    }
    
    Logger.log('âœ… ×¡× ×›×¨×•×Ÿ ×”×•×©×œ×: ' + updatedCount + ' ×¢×•×“×›× ×•, ' + skippedCount + ' × ×“×œ×’×•, ' + failedCount + ' × ×›×©×œ×•');
    if (invalidMatrimIdCount > 0) {
      Logger.log('âš ï¸ ' + invalidMatrimIdCount + ' ××ª×¨×™××™× ×œ× ×¢×•×“×›× ×• ×›×™ ××™×Ÿ ×œ×”× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ - ×™×© ×œ×”×¨×™×¥ "×¡× ×›×¨×•×Ÿ ×ª×¨×•××•×ª" ×›×“×™ ×œ×§×©×¨ ××•×ª×');
    }
    
    var message = '×¡× ×›×¨×•×Ÿ ×”×•×©×œ×: ' + updatedCount + ' ×¢×•×“×›× ×•';
    if (failedCount > 0) {
      message += ', ' + failedCount + ' × ×›×©×œ×•';
    }
    if (invalidMatrimIdCount > 0) {
      message += ', ' + invalidMatrimIdCount + ' ×œ×œ× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ';
    }
    
    return {
      success: true,
      message: message,
      updated: updatedCount,
      skipped: skippedCount,
      failed: failedCount,
      invalidMatrimId: invalidMatrimIdCount,
      total: donorsToUpdate.length
    };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¡× ×›×¨×•×Ÿ ××”×’×œ×™×•×Ÿ: ' + error.toString());
    return { success: false, error: error.message || '×©×’×™××” ×œ× ×™×“×•×¢×”' };
  }
}

/**
 * ×—×™×¤×•×© ××ª×¨×™××™× ×‘× ×“×¨×™× ×¤×œ×•×¡ (MatchPlus API)
 * ×× ×¡×” GET ×•×× ×”×ª×’×•×‘×” ×¨×™×§×” â€“ ×× ×¡×” POST (×—×œ×§ ××”×©×¨×ª×™× ×“×•×¨×©×™× POST)
 */
function searchNedarimRecruiters(searchTerm) {
  var cfg = getNedarimConfig();
  var baseUrl = cfg.MATCH_PLUS_API_URL;
  var params = 'Action=SearchMatrim&Name=' + encodeURIComponent(searchTerm || '') + '&MosadId=' + cfg.MOSAD_ID;
  var urlGet = baseUrl + '?' + params;
  var headers = { 'Accept': 'application/json', 'User-Agent': 'Mozilla/5.0 (compatible; Google-AppsScript; NedarimSync/1.0)' };
  
  function parseResponse(text) {
    var data;
    try { data = JSON.parse(text); } catch (e) { return { data: null, list: [] }; }
    var list = [];
    if (Array.isArray(data)) list = data;
    else if (data && Array.isArray(data.Matrim)) list = data.Matrim;
    else if (data && Array.isArray(data.recruiters)) list = data.recruiters;
    else if (data && data.Matrim && !Array.isArray(data.Matrim)) list = [data.Matrim];
    else if (data && data.d && Array.isArray(data.d)) list = data.d;
    else if (data && data.data && Array.isArray(data.data)) list = data.data;
    else if (data && data.result && Array.isArray(data.result)) list = data.result;
    else if (data && data.items && Array.isArray(data.items)) list = data.items;
    else if (data && data.List && Array.isArray(data.List)) list = data.List;
    else if (data && data.Table && Array.isArray(data.Table)) list = data.Table;
    else if (data && data.Rows && Array.isArray(data.Rows)) list = data.Rows;
    else if (data && data.MatrimList && Array.isArray(data.MatrimList)) list = data.MatrimList;
    else if (data && data.Recruiters && Array.isArray(data.Recruiters)) list = data.Recruiters;
    return { data: data, list: list };
  }
  
  try {
    var response = UrlFetchApp.fetch(urlGet, { method: 'GET', muteHttpExceptions: true, headers: headers });
    var code = response.getResponseCode();
    var text = response.getContentText();
    if (code !== 200) {
      Logger.log('searchNedarimRecruiters GET: ×§×•×“ ' + code);
      return { success: false, error: '×©×’×™××ª ×©×¨×ª ' + code, recruiters: [] };
    }
    var parsed = parseResponse(text);
    if (parsed.list.length > 0) {
      return { success: true, recruiters: parsed.list };
    }
    var data = parsed.data;
    var list = parsed.list;
    if (!data || typeof data !== 'object') {
      Logger.log('searchNedarimRecruiters: ×œ× JSON â€“ ' + text.substring(0, 150));
      return { success: false, error: '×ª×’×•×‘×” ×œ× ×ª×§×™× ×”', recruiters: [] };
    }
    var out = { success: true, recruiters: list };
    out._responseKeys = Object.keys(data);
    try { out._rawPreview = text.substring(0, 500); } catch (e) {}
    return out;
  } catch (e) {
    Logger.log('×©×’×™××” ×‘×—×™×¤×•×©: ' + e.message);
    return { success: false, error: e.message, recruiters: [] };
  }
}

/**
 * ××©×™×›×ª ×›×œ ×”××ª×¨×™××™× ×× ×“×¨×™× ×¤×œ×•×¡ (MatchPlus) â€“ ×—×™×¤×•×© ×¨×™×§ + ×—×™×¤×•×© ×œ×¤×™ ×-×ª
 * @param {boolean} light - ×× true, ×¨×§ ×—×™×¤×•×© ×¨×™×§ (1 ×§×¨×™××ª UrlFetch) â€“ ×—×•×¡×š ×§×•×˜×”
 * @returns ×¨×©×™××” ××œ××” ×¢× Id/MatrimId, Name, Cumule, Goal ×•×›×•'
 */
function getAllNedarimRecruiters(light) {
  try {
    var allRecruitersMap = {};
    if (light) {
      var r0 = searchNedarimRecruiters('');
      if (r0 && r0.success && r0.recruiters) {
        r0.recruiters.forEach(function(re, idx) {
          var id = re.Id || re.MatrimId || re.id || re.MatrimNumber;
          var key = (id != null && String(id).trim() !== '') ? String(id).trim() : ('n_0_' + idx);
          allRecruitersMap[key] = re;
        });
        var arr = [];
        for (var k in allRecruitersMap) { if (allRecruitersMap.hasOwnProperty(k)) arr.push(allRecruitersMap[k]); }
        return { success: true, recruiters: arr };
      }
      return { success: true, recruiters: [] };
    }
    // ×—×™×¤×•×© ×¨××©×•× ×™ â€“ ×œ× ××—×–×™×¨×™× ××•×§×“×! ×—×™×¤×•×© ×¨×™×§ ××—×–×™×¨ max 200, ×•×”×©××¨ ××•×¤×™×¢×™× ×¨×§ ×‘×—×™×¤×•×© ×œ×¤×™ ××•×ª
    var quickTerms = ['', ' ', '*'];
    for (var qt = 0; qt < quickTerms.length; qt++) {
      var res = searchNedarimRecruiters(quickTerms[qt]);
      if (res && res.success && res.recruiters && res.recruiters.length > 0) {
        res.recruiters.forEach(function(re, idx) {
          var id = re.Id || re.MatrimId || re.id || re.MatrimNumber;
          var key = (id != null && String(id).trim() !== '') ? String(id).trim() : ('q_' + qt + '_' + idx);
          allRecruitersMap[key] = re;
        });
      }
      if (qt < quickTerms.length - 1) Utilities.sleep(50);
    }
    var hebrewLetters = ['×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×›', '×œ', '×', '× ', '×¡', '×¢', '×¤', '×¦', '×§', '×¨', '×©', '×ª'];
    for (var i = 0; i < hebrewLetters.length; i++) {
      var term = hebrewLetters[i];
      try {
        var result = searchNedarimRecruiters(term);
        if (result && result.success && result.recruiters && result.recruiters.length > 0) {
          result.recruiters.forEach(function(r, idx) {
            var id = r.Id || r.MatrimId || r.id || r.MatrimNumber;
            var key;
            if (id !== undefined && id !== null && String(id).trim() !== '') {
              key = String(id).trim();
            } else {
              var name = (r.Name || r.name || '').trim();
              key = name ? 'name_' + name + '_' + i + '_' + idx : 'idx_' + i + '_' + idx;
            }
            allRecruitersMap[key] = r;
          });
        }
        if (i < hebrewLetters.length - 1) {
          Utilities.sleep(50);
        }
      } catch (e) {
        Logger.log('×©×’×™××” ×‘×—×™×¤×•×© "' + term + '": ' + e.message);
      }
    }
    
    var recruitersArray = [];
    for (var key in allRecruitersMap) {
      if (allRecruitersMap.hasOwnProperty(key)) {
        recruitersArray.push(allRecruitersMap[key]);
      }
    }
    
    Logger.log('getAllNedarimRecruiters: ×¡×”"×› ' + recruitersArray.length + ' ××ª×¨×™××™× ×× ×“×¨×™× ×¤×œ×•×¡');
    var out = { success: true, recruiters: recruitersArray };
    if (recruitersArray.length === 0) {
      var firstSearch = searchNedarimRecruiters('');
      out._debug = { firstSearchCount: (firstSearch.recruiters || []).length, firstSearchError: firstSearch.error || null, responseKeys: firstSearch._responseKeys || null };
    }
    return out;
  } catch (e) {
    Logger.log('×©×’×™××” ×‘-getAllNedarimRecruiters: ' + e.message);
    return { success: false, error: e.message, recruiters: [] };
  }
}
// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª ×’×™×œ×™×•×Ÿ ***
// *****************************************************************************

/**
 * ×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª ×× ×œ× ×§×™×™××™×
 */
function ensureSheetsExist() {
  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  // ×’×™×œ×™×•×Ÿ ××ª×¨×™××™×
  var donorsSheet = ss.getSheetByName(SHEET_NAMES.DONORS);
  if (!donorsSheet) {
    donorsSheet = ss.insertSheet(SHEET_NAMES.DONORS);
    donorsSheet.getRange(1, 1, 1, DONOR_COLUMNS.length).setValues([DONOR_COLUMNS]);
    formatHeader(donorsSheet);
  } else {
    // ×‘×“×™×§×” ×•×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª â€“ ×›×•×œ×œ ×ª×™×§×•×Ÿ ×× ×¢××•×“×” C (displayName) ×¨×™×§×”
    var headers = donorsSheet.getRange(1, 1, 1, Math.max(donorsSheet.getLastColumn(), DONOR_COLUMNS.length)).getValues()[0];
    var needsFix = headers.length !== DONOR_COLUMNS.length || headers[0] !== DONOR_COLUMNS[0];
    if (!needsFix && headers.indexOf('displayName') < 0) {
      // ×¢××•×“×” C ×¨×™×§×” ××• ×¢× ×›×•×ª×¨×ª ×©×’×•×™×” â€“ ××ª×§×Ÿ
      needsFix = true;
    }
    if (needsFix) {
      donorsSheet.getRange(1, 1, 1, DONOR_COLUMNS.length).setValues([DONOR_COLUMNS]);
      formatHeader(donorsSheet);
    }
  }
  
  // ×’×™×œ×™×•×Ÿ ×§×‘×•×¦×•×ª
  var groupsSheet = ss.getSheetByName(SHEET_NAMES.GROUPS);
  if (!groupsSheet) {
    groupsSheet = ss.insertSheet(SHEET_NAMES.GROUPS);
    groupsSheet.getRange(1, 1, 1, GROUP_COLUMNS.length).setValues([GROUP_COLUMNS]);
    formatHeader(groupsSheet);
  } else {
    var groupHeaders = groupsSheet.getRange(1, 1, 1, Math.max(groupsSheet.getLastColumn(), GROUP_COLUMNS.length)).getValues()[0];
    var groupNeedsFix = groupHeaders.length !== GROUP_COLUMNS.length || groupHeaders[0] !== GROUP_COLUMNS[0];
    if (!groupNeedsFix && groupHeaders.indexOf('name') < 0) groupNeedsFix = true;
    if (groupNeedsFix) {
      groupsSheet.getRange(1, 1, 1, GROUP_COLUMNS.length).setValues([GROUP_COLUMNS]);
      formatHeader(groupsSheet);
    }
  }
  
  // ×’×™×œ×™×•×Ÿ ×”×’×“×¨×•×ª
  var settingsSheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
  if (!settingsSheet) {
    settingsSheet = ss.insertSheet(SHEET_NAMES.SETTINGS);
    settingsSheet.getRange(1, 1, 1, 2).setValues([['key', 'value']]);
    formatHeader(settingsSheet);
  }
  
  // ×’×™×œ×™×•×Ÿ ×›×ª×•×‘×•×ª
  var addressesSheet = ss.getSheetByName(SHEET_NAMES.ADDRESSES);
  if (!addressesSheet) {
    addressesSheet = ss.insertSheet(SHEET_NAMES.ADDRESSES);
    addressesSheet.getRange(1, 1, 1, ADDRESS_COLUMNS.length).setValues([ADDRESS_COLUMNS]);
    formatHeader(addressesSheet);
  } else {
    var addrHeaders = addressesSheet.getRange(1, 1, 1, addressesSheet.getLastColumn()).getValues()[0];
    if (addrHeaders.length !== ADDRESS_COLUMNS.length || addrHeaders[0] !== ADDRESS_COLUMNS[0]) {
      addressesSheet.getRange(1, 1, 1, ADDRESS_COLUMNS.length).setValues([ADDRESS_COLUMNS]);
      formatHeader(addressesSheet);
    }
  }
  
  // ×’×™×œ×™×•×Ÿ ×¡×™×™×¨×•×ª
  var scoutsSheet = ss.getSheetByName(SHEET_NAMES.SCOUTS);
  if (!scoutsSheet) {
    scoutsSheet = ss.insertSheet(SHEET_NAMES.SCOUTS);
    scoutsSheet.getRange(1, 1, 1, SCOUT_COLUMNS.length).setValues([SCOUT_COLUMNS]);
    formatHeader(scoutsSheet);
  } else {
    var scoutHeaders = scoutsSheet.getRange(1, 1, 1, scoutsSheet.getLastColumn()).getValues()[0];
    if (scoutHeaders.length !== SCOUT_COLUMNS.length || scoutHeaders[0] !== SCOUT_COLUMNS[0]) {
      scoutsSheet.getRange(1, 1, 1, SCOUT_COLUMNS.length).setValues([SCOUT_COLUMNS]);
      formatHeader(scoutsSheet);
    }
  }
  
  // ×’×™×œ×™×•×Ÿ ×”×™×¡×˜×•×¨×™×”
  var historySheet = ss.getSheetByName(SHEET_NAMES.HISTORY);
  if (!historySheet) {
    historySheet = ss.insertSheet(SHEET_NAMES.HISTORY);
    historySheet.getRange(1, 1, 1, 9).setValues([['timestamp', 'date', 'time', 'actionType', 'entityName', 'details', 'amount', 'source', 'computerName']]);
    formatHeader(historySheet);
  }
  
  return { donors: donorsSheet, groups: groupsSheet, settings: settingsSheet, addresses: addressesSheet, scouts: scoutsSheet, history: historySheet };
}

function formatHeader(sheet) {
  var headerRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#D4AF37');
  headerRange.setFontColor('#FFFFFF');
  sheet.setFrozenRows(1);
}

// *****************************************************************************
// *** ×§×¨×™××ª × ×ª×•× ×™× ***
// *****************************************************************************

function getAllDonors() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.DONORS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      Logger.log('âš ï¸ ××™×Ÿ ××ª×¨×™××™× ×‘×’×œ×™×•×Ÿ (×”×’×œ×™×•×Ÿ ×¨×™×§ ××• ×œ× ×§×™×™×)');
      return { success: true, donors: [], donorsWithValidMatrimId: 0 };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    // ×‘×“×™×§×” ×©×”×¢××•×“×” nedarimMatrimId ×§×™×™××ª
    var hasNedarimMatrimIdColumn = false;
    var nedarimMatrimIdIndex = -1;
    for (var h = 0; h < headers.length; h++) {
      if (headers[h] === 'nedarimMatrimId') {
        hasNedarimMatrimIdColumn = true;
        nedarimMatrimIdIndex = h;
        break;
      }
    }
    
    // ×× ×”×¢××•×“×” ×œ× ×§×™×™××ª, × ×•×¡×™×£ ××•×ª×”
    if (!hasNedarimMatrimIdColumn) {
      Logger.log('âš ï¸ ×”×¢××•×“×” nedarimMatrimId ×œ× ×§×™×™××ª - ××•×¡×™×£ ××•×ª×”...');
      var lastCol = sheet.getLastColumn();
      sheet.getRange(1, lastCol + 1).setValue('nedarimMatrimId');
      formatHeader(sheet);
      // ×§×•×¨× ××—×“×© ××ª ×”× ×ª×•× ×™×
      data = sheet.getDataRange().getValues();
      headers = data[0];
      nedarimMatrimIdIndex = headers.length - 1;
      Logger.log('âœ… ×”×¢××•×“×” nedarimMatrimId × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
    }
    
    var donors = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var donor = {};
      
      for (var j = 0; j < headers.length; j++) {
        var key = (headers[j] && String(headers[j]).trim()) || (j < DONOR_COLUMNS.length ? DONOR_COLUMNS[j] : null);
        var value = row[j];
        
        if (!key) continue;
        
        if (key === 'amount' || key === 'personalGoal') {
          donor[key] = value ? Number(value) : 0;
        } else if (key === 'groupId') {
          donor[key] = value !== '' && value !== null ? value : '';
        } else if (key === 'nedarimMatrimId') {
          // ××¡×¤×¨ ××ª×¨×™× - ×©×•××¨ ×›×˜×§×¡×˜ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”××¡×¤×¨ ×”××§×•×¨×™
          donor[key] = value !== undefined && value !== null && value !== '' ? String(value).trim() : null;
        } else {
          donor[key] = value !== undefined && value !== null ? value : '';
        }
      }
      
        if (donor.id) {
        // ×¢××•×“×” B = ×©× ××§×•×¨×™ ×× ×“×¨×™× â€“ ×©×•××¨×™× ××•×ª×• ×œ-originalName ×›×“×™ ×©×œ× ×™×“×¨×¡ ×‘×©××™×¨×”
        if (!donor.originalName && donor.name) {
          donor.originalName = donor.name;
        }
        // ×‘×“×™×§×” ×©-nedarimMatrimId × ×˜×¢×Ÿ × ×›×•×Ÿ
        if (donor.nedarimMatrimId) {
          var matrimIdStr = String(donor.nedarimMatrimId).trim();
          // ×× ×–×” ×ª××¨×™×š, ××–×”×™×¨
          if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(matrimIdStr) || matrimIdStr.includes('T') || matrimIdStr.includes('Z')) {
            Logger.log('âš ï¸ ××ª×¨×™× ' + donor.name + ' ×™×© ×œ×• ××¡×¤×¨ ××ª×¨×™× ×œ× ×ª×§×™×Ÿ (×ª××¨×™×š): ' + matrimIdStr);
          }
        }
        donors.push(donor);
      }
    }
    
    // ×¡×¤×™×¨×ª ××ª×¨×™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ
    var donorsWithValidMatrimId = 0;
    for (var k = 0; k < donors.length; k++) {
      if (donors[k].nedarimMatrimId) {
        var idStr = String(donors[k].nedarimMatrimId).trim();
        if (/^\d+$/.test(idStr)) {
          donorsWithValidMatrimId++;
        }
      }
    }
    
    Logger.log('ğŸ“¥ × ×˜×¢× ×• ' + donors.length + ' ××ª×¨×™××™× ××”×’×œ×™×•×Ÿ');
    Logger.log('ğŸ“¥ ××ª×¨×™××™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ: ' + donorsWithValidMatrimId + ' ××ª×•×š ' + donors.length);
    
    if (donors.length > 0 && donorsWithValidMatrimId === 0) {
      Logger.log('âš ï¸ ××™×Ÿ ××ª×¨×™××™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ! ×™×© ×œ×§×©×¨ ××ª×¨×™××™× ×œ××¡×¤×¨ ××ª×¨×™× ×× ×“×¨×™× ×¤×œ×•×¡ ×“×¨×š ×›×¤×ª×•×¨ "×¡× ×›×¨×•×Ÿ ×ª×¨×•××•×ª"');
    }
    
    return { success: true, donors: donors, donorsWithValidMatrimId: donorsWithValidMatrimId };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×§×¨×™××ª ××ª×¨×™××™×: ' + error.toString());
    return { success: false, error: error.toString(), donors: [], donorsWithValidMatrimId: 0 };
  }
}

function getAllGroups() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.GROUPS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, groups: [] };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var groups = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var group = {};
      
      for (var j = 0; j < headers.length; j++) {
        var rawKey = (headers[j] && String(headers[j]).trim()) || (j < GROUP_COLUMNS.length ? GROUP_COLUMNS[j] : null);
        if (!rawKey) continue;
        var key = rawKey === 'groupId' ? 'id' : (rawKey === 'groupName' ? 'name' : rawKey);
        var value = row[j];
        
        if (key === 'goal' || key === 'orderNumber') {
          group[key] = value ? Number(value) : 0;
        } else if (key === 'showInLiveView') {
          group[key] = value !== false && value !== 'false';
        } else {
          group[key] = value !== undefined && value !== null ? value : '';
        }
      }
      
      if (group.id) {
        groups.push(group);
      }
    }
    
    return { success: true, groups: groups };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×§×‘×•×¦×•×ª: ' + error.toString());
    return { success: false, error: error.toString(), groups: [] };
  }
}

function getAllAddresses() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.ADDRESSES);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, addresses: [] };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var addresses = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var addr = {};
      
      for (var j = 0; j < headers.length; j++) {
        var key = headers[j];
        var value = row[j];
        
        if (!key) continue;
        
        if (key === 'amount') {
          addr[key] = value ? Number(value) : 0;
        } else {
          addr[key] = value !== undefined && value !== null ? value : '';
        }
      }
      
      if (addr.id) {
        addresses.push(addr);
      }
    }
    
    Logger.log('× ×˜×¢× ×• ' + addresses.length + ' ×›×ª×•×‘×•×ª ××”×’×œ×™×•×Ÿ');
    return { success: true, addresses: addresses };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×›×ª×•×‘×•×ª: ' + error.toString());
    return { success: false, error: error.toString(), addresses: [] };
  }
}

function getAllScouts() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.SCOUTS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, scoutsSchedule: { day14: [], day15: [] } };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var dayIdx = headers.indexOf('day');
    var teamIdIdx = headers.indexOf('teamId');
    var teamNameIdx = headers.indexOf('teamName');
    var cityIdx = headers.indexOf('city');
    var leaderIdx = headers.indexOf('leader');
    var manualTotalIdx = headers.indexOf('manualTotal');
    var membersJsonIdx = headers.indexOf('membersJson');
    
    var scoutsSchedule = {};
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var day = row[dayIdx] || '';
      if (!day) continue;
      
      if (!scoutsSchedule[day]) {
        scoutsSchedule[day] = [];
      }
      
      var members = [];
      try {
        var mj = row[membersJsonIdx];
        if (mj && String(mj).trim()) {
          members = JSON.parse(mj);
          if (!Array.isArray(members)) members = [];
        }
      } catch (e) {}
      
      var team = {
        id: row[teamIdIdx] || ('scout_team_' + Date.now() + '_' + i),
        name: (row[teamNameIdx] || '×¡×™×¨×ª ').toString(),
        city: row[cityIdx] || '',
        leader: (row[leaderIdx] || '').toString(),
        members: members
      };
      
      var manualVal = row[manualTotalIdx];
      if (manualVal !== undefined && manualVal !== null && manualVal !== '') {
        var num = Number(manualVal);
        if (!isNaN(num) && num > 0) {
          team.manualTotal = Math.round(num);
        }
      }
      
      scoutsSchedule[day].push(team);
    }
    
    if (!scoutsSchedule.day14) scoutsSchedule.day14 = [];
    if (!scoutsSchedule.day15) scoutsSchedule.day15 = [];
    
    Logger.log('× ×˜×¢× ×• ×¡×™×™×¨×•×ª ××”×’×œ×™×•×Ÿ: day14=' + (scoutsSchedule.day14 ? scoutsSchedule.day14.length : 0) + ', day15=' + (scoutsSchedule.day15 ? scoutsSchedule.day15.length : 0));
    return { success: true, scoutsSchedule: scoutsSchedule };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×¡×™×™×¨×•×ª: ' + error.toString());
    return { success: false, error: error.toString(), scoutsSchedule: { day14: [], day15: [] } };
  }
}

function getAllSettings() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, settings: {} };
    }
    
    var data = sheet.getDataRange().getValues();
    var settings = {};
    
    for (var i = 1; i < data.length; i++) {
      var key = data[i][0];
      var value = data[i][1];
      
      if (key) {
        try {
          settings[key] = JSON.parse(value);
        } catch (e) {
          settings[key] = value;
        }
      }
    }
    
    return { success: true, settings: settings };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×”×’×“×¨×•×ª: ' + error.toString());
    return { success: false, error: error.toString(), settings: {} };
  }
}

function getAllData() {
  try {
    var donors = getAllDonors();
    var groups = getAllGroups();
    var addressesResult = getAllAddresses();
    var scoutsResult = getAllScouts();
    var settings = getAllSettings();
    
    var settingsObj = settings.settings || {};
    if (addressesResult.success && addressesResult.addresses && addressesResult.addresses.length > 0) {
      settingsObj.addresses = addressesResult.addresses;
    } else if (!settingsObj.addresses || !Array.isArray(settingsObj.addresses)) {
      settingsObj.addresses = [];
    }
    
    if (scoutsResult.success && scoutsResult.scoutsSchedule && Object.keys(scoutsResult.scoutsSchedule).length > 0) {
      settingsObj.scoutsSchedule = scoutsResult.scoutsSchedule;
    } else if (!settingsObj.scoutsSchedule || typeof settingsObj.scoutsSchedule !== 'object') {
      settingsObj.scoutsSchedule = { day14: [], day15: [] };
    }
    
    return {
      success: true,
      donors: donors.donors || [],
      groups: groups.groups || [],
      settings: settingsObj,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™×: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/** ×˜×¢×™× ×” ×œ×œ× ××ª×¨×™××™× â€“ ×§×‘×•×¦×•×ª ×•×”×’×“×¨×•×ª ××”×’×œ×™×•×Ÿ. ××ª×¨×™××™× ×™×™×˜×¢× ×• ×× ×“×¨×™× ×¤×œ×•×¡ (××•× ×¢ ×“×¨×™×¡×ª ×¡×›×•××™×/×¢××•×“×” C) */
function getAllDataNoDonors() {
  try {
    var groups = getAllGroups();
    var addressesResult = getAllAddresses();
    var scoutsResult = getAllScouts();
    var settings = getAllSettings();
    
    var settingsObj = settings.settings || {};
    if (addressesResult.success && addressesResult.addresses && addressesResult.addresses.length > 0) {
      settingsObj.addresses = addressesResult.addresses;
    } else if (!settingsObj.addresses || !Array.isArray(settingsObj.addresses)) {
      settingsObj.addresses = [];
    }
    
    if (scoutsResult.success && scoutsResult.scoutsSchedule && Object.keys(scoutsResult.scoutsSchedule).length > 0) {
      settingsObj.scoutsSchedule = scoutsResult.scoutsSchedule;
    } else if (!settingsObj.scoutsSchedule || typeof settingsObj.scoutsSchedule !== 'object') {
      settingsObj.scoutsSchedule = { day14: [], day15: [] };
    }
    
    return {
      success: true,
      donors: [],
      groups: groups.groups || [],
      settings: settingsObj,
      noDonorsFromSheet: true,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-getAllDataNoDonors: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// *****************************************************************************
// *** ×©××™×¨×ª × ×ª×•× ×™× ***
// *****************************************************************************

function saveDonors(donors, groups) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.DONORS);
    
    // âš ï¸ ×©××™×¨×ª displayName ××”×’×œ×™×•×Ÿ ×œ×¤× ×™ ×“×¨×™×¡×” â€“ ××•× ×¢ ××—×™×§×ª ×©××•×ª ×ª×¦×•×’×” (×¢××•×“×” C) ×›×©×”×œ×§×•×— ×©×•×œ×— ×¢×¨×š ×¨×™×§
    var existingDisplayNamesById = {};
    var existingDisplayNamesByMatrimId = {};
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var data = sheet.getDataRange().getValues();
      var headers = data[0];
      var idIdx = headers.indexOf('id');
      var matrimIdx = headers.indexOf('nedarimMatrimId');
      var displayIdx = headers.indexOf('displayName');
      if (displayIdx < 0 && DONOR_COLUMNS.indexOf('displayName') >= 0) {
        displayIdx = DONOR_COLUMNS.indexOf('displayName'); // ×¢××•×“×” C â€“ ×’× ×× ×”×›×•×ª×¨×ª ×¨×™×§×”
      }
      if (displayIdx >= 0 && (idIdx >= 0 || matrimIdx >= 0)) {
        for (var r = 1; r < data.length; r++) {
          var row = data[r];
          var dn = (row[displayIdx] !== undefined && row[displayIdx] !== null && String(row[displayIdx]).trim() !== '') ? String(row[displayIdx]).trim() : '';
          if (!dn) continue;
          if (idIdx >= 0 && row[idIdx]) existingDisplayNamesById[String(row[idIdx])] = dn;
          if (matrimIdx >= 0 && row[matrimIdx]) {
            var mid = String(row[matrimIdx]).trim();
            if (/^\d+$/.test(mid)) existingDisplayNamesByMatrimId[mid] = dn;
          }
        }
      }
    }
    
    // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™× - ××©×ª××© ×‘-clearContent ×‘××§×•× deleteRows ×›×“×™ ×œ×× ×•×¢ ×©×’×™××ª ×©×•×¨×•×ª ××•×§×¤××•×ª
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || DONOR_COLUMNS.length;
      sheet.getRange(2, 1, lastRow, lastCol).clearContent();
    }
    
    if (!donors || donors.length === 0) {
      return { success: true, message: '××™×Ÿ ××ª×¨×™××™× ×œ×©××™×¨×”', count: 0 };
    }
    
    // ×‘× ×™×™×ª ××¤×ª ×§×‘×•×¦×•×ª (id -> name)
    var groupsMap = {};
    if (groups && groups.length > 0) {
      for (var g = 0; g < groups.length; g++) {
        groupsMap[groups[g].id] = groups[g].name || '';
      }
    } else {
      // ×× ××™×Ÿ ×§×‘×•×¦×•×ª, × × ×¡×” ×œ×§×¨×•× ××”×’×™×œ×™×•×Ÿ
      var groupsResult = getAllGroups();
      if (groupsResult.groups) {
        for (var g = 0; g < groupsResult.groups.length; g++) {
          groupsMap[groupsResult.groups[g].id] = groupsResult.groups[g].name || '';
        }
      }
    }
    
    // ×‘× ×™×™×ª ×©×•×¨×•×ª
    var rows = [];
    var now = new Date().toISOString();
    
    for (var i = 0; i < donors.length; i++) {
      var donor = donors[i];
      var row = [];
      
      for (var j = 0; j < DONOR_COLUMNS.length; j++) {
        var col = DONOR_COLUMNS[j];
        
        switch(col) {
          case 'groupName':
            row.push(groupsMap[donor.groupId] || '');
            break;
          case 'updatedAt':
            row.push(now);
            break;
          case 'createdAt':
            row.push(donor.createdAt || now);
            break;
          case 'source':
            row.push(donor.source || donor.fromNedarimPlus ? 'nedarim_plus' : 'manual');
            break;
          case 'name':
            // ×¢××•×“×” B: ×ª××™×“ ×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× â€“ ×œ× ×œ×¢×“×›×Ÿ ×‘×ª×™×§×•× ×™×. ××•× ×¢ ×“×¨×™×¡×ª ×”×©× ×”××§×•×¨×™.
            row.push(donor.originalName || donor.name || '');
            break;
          case 'displayName':
            // ×¢××•×“×” C: ×”×©× ×”××ª×•×§×Ÿ ×›×¤×™ ×©×”×•× ××•×¤×™×¢ ×‘×ª×•×›× ×” â€“ ×œ× ×œ×“×¨×•×¡ ×¢× ×¨×™×§ ×× ×‘×’×œ×™×•×Ÿ ×™×© ×¢×¨×š
            var toWrite = (donor.displayName !== undefined && donor.displayName !== null && String(donor.displayName).trim() !== '') ? String(donor.displayName).trim() : '';
            if (!toWrite) {
              var existingById = donor.id ? existingDisplayNamesById[String(donor.id)] : null;
              var existingByMatrim = donor.nedarimMatrimId && /^\d+$/.test(String(donor.nedarimMatrimId).trim()) ? existingDisplayNamesByMatrimId[String(donor.nedarimMatrimId).trim()] : null;
              toWrite = existingById || existingByMatrim || '';
            }
            row.push(toWrite);
            break;
          case 'nedarimMatrimId':
            // ××¡×¤×¨ ××ª×¨×™× - ×©×•××¨ ×›×˜×§×¡×˜ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”××¡×¤×¨ ×”××§×•×¨×™
            var matrimId = donor.nedarimMatrimId;
            var matrimIdStr = matrimId !== undefined && matrimId !== null && matrimId !== '' ? String(matrimId).trim() : '';
            
            // ×‘×•×“×§ ×× ×–×” ××¡×¤×¨ ×××™×ª×™ (×œ× ×ª××¨×™×š)
            if (matrimIdStr) {
              // ×× ×–×” ×ª××¨×™×š ××• ×œ× ××¡×¤×¨ ×ª×§×™×Ÿ, ×œ× ×©×•××¨ ××•×ª×•
              var isDate = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(matrimIdStr) || matrimIdStr.includes('T') || matrimIdStr.includes('Z');
              var isNumeric = /^\d+$/.test(matrimIdStr);
              
              if (isDate || !isNumeric) {
                Logger.log('âš ï¸ ××ª×¨×™× ' + donor.name + ' ×™×© ×œ×• ××¡×¤×¨ ××ª×¨×™× ×œ× ×ª×§×™×Ÿ (×ª××¨×™×š ××• ×œ× ××¡×¤×¨×™): ' + matrimIdStr + ' - ×œ× ×©×•××¨ ×œ×’×œ×™×•×Ÿ');
                row.push(''); // ×œ× ×©×•××¨ ×ª××¨×™×š ××• ××¡×¤×¨ ×œ× ×ª×§×™×Ÿ
              } else {
                // ×–×” ××¡×¤×¨ ×ª×§×™×Ÿ - ×©×•××¨ ××•×ª×•
                Logger.log('âœ… ×©×•××¨ ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ ×œ××ª×¨×™× ' + donor.name + ': ' + matrimIdStr);
                row.push(matrimIdStr);
              }
            } else {
              // ××™×Ÿ ××¡×¤×¨ ××ª×¨×™×
              row.push('');
            }
            break;
          default:
            var value = donor[col];
            row.push(value !== undefined && value !== null ? value : '');
        }
      }
      
      rows.push(row);
    }
    
    // ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, DONOR_COLUMNS.length).setValues(rows);
    }
    
    // ×‘×“×™×§×” ×›××” ××ª×¨×™× ×™×© ×œ×”× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ
    var donorsWithMatrimId = 0;
    for (var k = 0; k < donors.length; k++) {
      if (donors[k].nedarimMatrimId && String(donors[k].nedarimMatrimId).trim() !== '') {
        var matrimIdStr = String(donors[k].nedarimMatrimId).trim();
        var isNumeric = /^\d+$/.test(matrimIdStr);
        if (isNumeric) {
          donorsWithMatrimId++;
        }
      }
    }
    
    Logger.log('× ×©××¨×• ' + donors.length + ' ××ª×¨×™××™×');
    Logger.log('××ª×¨×™××™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ: ' + donorsWithMatrimId + ' ××ª×•×š ' + donors.length);
    return { success: true, message: '× ×©××¨×• ' + donors.length + ' ××ª×¨×™××™×', count: donors.length, donorsWithMatrimId: donorsWithMatrimId };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ××ª×¨×™××™×: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveGroups(groups) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.GROUPS);
    
    // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™× - ××©×ª××© ×‘-clearContent ×‘××§×•× deleteRows
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || GROUP_COLUMNS.length;
      sheet.getRange(2, 1, lastRow - 1, lastCol).clearContent();
    }
    
    if (!groups || groups.length === 0) {
      return { success: true, message: '××™×Ÿ ×§×‘×•×¦×•×ª ×œ×©××™×¨×”', count: 0 };
    }
    
    // ×‘× ×™×™×ª ×©×•×¨×•×ª
    var rows = [];
    var now = new Date().toISOString();
    
    for (var i = 0; i < groups.length; i++) {
      var group = groups[i];
      var row = [];
      
      for (var j = 0; j < GROUP_COLUMNS.length; j++) {
        var col = GROUP_COLUMNS[j];
        
        switch(col) {
          case 'updatedAt':
            row.push(now);
            break;
          case 'createdAt':
            row.push(group.createdAt || now);
            break;
          case 'showInLiveView':
            row.push(group.showInLiveView !== false);
            break;
          default:
            var value = group[col];
            row.push(value !== undefined && value !== null ? value : '');
        }
      }
      
      rows.push(row);
    }
    
    // ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, GROUP_COLUMNS.length).setValues(rows);
    }
    
    Logger.log('× ×©××¨×• ' + groups.length + ' ×§×‘×•×¦×•×ª');
    return { success: true, message: '× ×©××¨×• ' + groups.length + ' ×§×‘×•×¦×•×ª', count: groups.length };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×§×‘×•×¦×•×ª: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveAddresses(addresses) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.ADDRESSES);
    
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || ADDRESS_COLUMNS.length;
      sheet.getRange(2, 1, lastRow, lastCol).clearContent();
    }
    
    if (!addresses || addresses.length === 0) {
      Logger.log('××™×Ÿ ×›×ª×•×‘×•×ª ×œ×©××™×¨×”');
      return { success: true, message: '××™×Ÿ ×›×ª×•×‘×•×ª ×œ×©××™×¨×”', count: 0 };
    }
    
    var rows = [];
    for (var i = 0; i < addresses.length; i++) {
      var addr = addresses[i];
      var row = [];
      
      for (var j = 0; j < ADDRESS_COLUMNS.length; j++) {
        var col = ADDRESS_COLUMNS[j];
        var value = addr[col];
        if (value !== undefined && value !== null) {
          row.push(value);
        } else {
          row.push('');
        }
      }
      rows.push(row);
    }
    
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, ADDRESS_COLUMNS.length).setValues(rows);
    }
    
    Logger.log('× ×©××¨×• ' + addresses.length + ' ×›×ª×•×‘×•×ª ×œ×’×œ×™×•×Ÿ');
    return { success: true, message: '× ×©××¨×• ' + addresses.length + ' ×›×ª×•×‘×•×ª', count: addresses.length };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×›×ª×•×‘×•×ª: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveScouts(scoutsSchedule) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.SCOUTS);
    
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || SCOUT_COLUMNS.length;
      sheet.getRange(2, 1, lastRow, lastCol).clearContent();
    }
    
    if (!scoutsSchedule || typeof scoutsSchedule !== 'object') {
      Logger.log('××™×Ÿ × ×ª×•× ×™ ×¡×™×™×¨×•×ª ×œ×©××™×¨×”');
      return { success: true, message: '××™×Ÿ × ×ª×•× ×™ ×¡×™×™×¨×•×ª', count: 0 };
    }
    
    var rows = [];
    var dayKeys = Object.keys(scoutsSchedule);
    
    for (var d = 0; d < dayKeys.length; d++) {
      var day = dayKeys[d];
      var teams = scoutsSchedule[day];
      if (!Array.isArray(teams)) continue;
      
      for (var t = 0; t < teams.length; t++) {
        var team = teams[t];
        var membersJson = '';
        try {
          membersJson = JSON.stringify(team.members || []);
        } catch (e) {
          membersJson = '[]';
        }
        
        var manualTotal = '';
        if (typeof team.manualTotal === 'number' && team.manualTotal > 0) {
          manualTotal = team.manualTotal;
        }
        
        rows.push([
          day,
          team.id || '',
          (team.name || '×¡×™×¨×ª ').toString(),
          team.city || '',
          (team.leader || '').toString(),
          manualTotal,
          membersJson
        ]);
      }
    }
    
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, SCOUT_COLUMNS.length).setValues(rows);
    }
    
    Logger.log('× ×©××¨×• ' + rows.length + ' ×¡×™×¨×•×ª ×œ×’×œ×™×•×Ÿ');
    return { success: true, message: '× ×©××¨×• ' + rows.length + ' ×¡×™×¨×•×ª', count: rows.length };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×¡×™×™×¨×•×ª: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveSettings(settings) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
    
    // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™× - ××©×ª××© ×‘-clearContent ×‘××§×•× deleteRows ×›×“×™ ×œ×× ×•×¢ ×©×’×™××ª ×©×•×¨×•×ª ××•×§×¤××•×ª
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || 2;
      sheet.getRange(2, 1, lastRow - 1, lastCol).clearContent();
    }
    
    if (!settings || Object.keys(settings).length === 0) {
      return { success: true, message: '××™×Ÿ ×”×’×“×¨×•×ª ×œ×©××™×¨×”', count: 0 };
    }
    
    // ×‘× ×™×™×ª ×©×•×¨×•×ª
    var rows = [];
    var keys = Object.keys(settings);
    
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      var value = settings[key];
      
      if (typeof value === 'object') {
        value = JSON.stringify(value);
      }
      
      rows.push([key, value]);
    }
    
    // ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, 2).setValues(rows);
    }
    
    Logger.log('× ×©××¨×• ' + keys.length + ' ×”×’×“×¨×•×ª');
    return { success: true, message: '× ×©××¨×• ' + keys.length + ' ×”×’×“×¨×•×ª', count: keys.length };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×”×’×“×¨×•×ª: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveAllData(data) {
  try {
    var results = {};
    
    // ×©×•××¨×™× ×§×‘×•×¦×•×ª ×§×•×“×
    if (data.groups) {
      results.groups = saveGroups(data.groups);
    }
    
    // ×©×•××¨×™× ××ª×¨×™××™× ×¢× ×”×§×‘×•×¦×•×ª
    if (data.donors) {
      results.donors = saveDonors(data.donors, data.groups);
    }
    
    // ×©×•××¨×™× ×›×ª×•×‘×•×ª ××”×ª×•×›× ×” ×œ×’×™×œ×™×•×Ÿ "×›×ª×•×‘×•×ª"
    var addressesToSave = (data.addresses && Array.isArray(data.addresses)) ? data.addresses : 
      (data.settings && data.settings.addresses && Array.isArray(data.settings.addresses)) ? data.settings.addresses : [];
    if (addressesToSave.length > 0) {
      results.addresses = saveAddresses(addressesToSave);
      Logger.log('× ×©××¨×• ' + addressesToSave.length + ' ×›×ª×•×‘×•×ª ×œ×’×™×œ×™×•×Ÿ');
    }
    
    // ×©×•××¨×™× ×¡×™×™×¨×•×ª ×œ×’×™×œ×™×•×Ÿ "×¡×™×™×¨×•×ª"
    var scoutsToSave = (data.scoutsSchedule && typeof data.scoutsSchedule === 'object') ? data.scoutsSchedule :
      (data.settings && data.settings.scoutsSchedule && typeof data.settings.scoutsSchedule === 'object') ? data.settings.scoutsSchedule : null;
    if (scoutsToSave && Object.keys(scoutsToSave).length > 0) {
      results.scouts = saveScouts(scoutsToSave);
      Logger.log('× ×©××¨×• × ×ª×•× ×™ ×¡×™×™×¨×•×ª ×œ×’×™×œ×™×•×Ÿ');
    }
    
    // ×©×•××¨×™× ×”×’×“×¨×•×ª
    if (data.settings) {
      results.settings = saveSettings(data.settings);
    }
    
    return {
      success: true,
      results: results,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×›×œ ×”× ×ª×•× ×™×: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// *****************************************************************************
// *** ×§×•×“ ×›× ×™×¡×” ×œ×ª×•×›× ×” â€“ × ×©××¨ ×‘×¦×“ ×©×¨×ª ×‘×œ×‘×“ ***
// *****************************************************************************

var APP_ENTRY_CODE_PROP = 'APP_ENTRY_CODE';
var DEFAULT_ENTRY_CODE = 'ttot02';

/**
 * GET: ×”×× × ×“×¨×© ×§×•×“ ×›× ×™×¡×” (×ª××™×“ true â€“ ×”×§×•×“ × ×‘×“×§ ×‘×©×¨×ª)
 */
function getEntryCodeSettings() {
  return { success: true, requireEntryCode: true };
}

/**
 * POST: ××™××•×ª ×§×•×“ ×›× ×™×¡×” â€“ ×”×§×•×“ × ×©××¨ ×‘-Script Properties ×‘×œ×‘×“
 * @param {string} code - ×§×•×“ ×©×”××©×ª××© ×”×–×™×Ÿ
 */
function verifyEntryCodeHandler(code) {
  try {
    var props = PropertiesService.getScriptProperties();
    var storedCode = (props.getProperty(APP_ENTRY_CODE_PROP) || DEFAULT_ENTRY_CODE).trim();
    var entered = (code && typeof code === 'string') ? code.trim() : '';
    var ok = entered.length > 0 && entered === storedCode;
    if (ok) {
      Logger.log('×§×•×“ ×›× ×™×¡×” ××•××ª ×‘×”×¦×œ×—×”');
    }
    return { success: ok };
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-verifyEntryCodeHandler: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// *****************************************************************************
// *** ×¡×™×¡××ª ×›× ×™×¡×” ×œ×ª×•×›× ×” â€“ × ×©××¨×ª ×‘×¦×“ ×©×¨×ª ×‘×œ×‘×“ ***
// *****************************************************************************

var APP_LOGIN_PROP_REQUIRED = 'APP_LOGIN_REQUIRED';
var APP_LOGIN_PROP_HASH = 'APP_LOGIN_PASSWORD_HASH';

/**
 * ×™×¦×™×¨×ª hash ×œ×¡×™×¡××” (SHA-256 + Base64) â€“ ×œ× ×©×•××¨×™× ×¡×™×¡××” ×‘×˜×§×¡×˜ ×’×œ×•×™
 */
function hashAppLoginPassword(plain) {
  if (!plain || typeof plain !== 'string') return '';
  var digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, plain.trim(), Utilities.Charset.UTF_8);
  var hash = '';
  for (var i = 0; i < digest.length; i++) {
    var b = digest[i];
    if (b < 0) b += 256;
    hash += ('0' + b.toString(16)).slice(-2);
  }
  return hash;
}

/**
 * GET: ×”×—×–×¨×ª ×”×’×“×¨×•×ª ×›× ×™×¡×” (×‘×œ×™ ×”×¡×™×¡××”) â€“ ×”×× × ×“×¨×©×ª ×¡×™×¡××” ×‘××¡×š ×”×›× ×™×¡×”
 */
function getAppLoginSettings() {
  try {
    var props = PropertiesService.getScriptProperties();
    var required = props.getProperty(APP_LOGIN_PROP_REQUIRED);
    var requireAppUnlock = required === 'true' || required === '1';
    return { success: true, requireAppUnlock: requireAppUnlock };
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-getAppLoginSettings: ' + error.toString());
    return { success: false, error: error.toString(), requireAppUnlock: false };
  }
}

/**
 * POST: ×©××™×¨×ª ×¡×™×¡××ª ×›× ×™×¡×” ×•×”×’×“×¨×” ×× ×œ×“×¨×•×© ×¡×™×¡××” ×‘××¡×š ×”×›× ×™×¡×”
 * @param {string} password - ×¡×™×¡××” (× ×©××¨×ª ×›-hash)
 * @param {boolean} requireAppUnlock - ×”×× ×œ×“×¨×•×© ×¡×™×¡××” ×›×‘×¨ ×‘××¡×š ×”×›× ×™×¡×”
 */
function setAppLoginPasswordHandler(password, requireAppUnlock) {
  try {
    var props = PropertiesService.getScriptProperties();
    var plain = (password && typeof password === 'string') ? password.trim() : '';
    var requireOn = (requireAppUnlock === true || requireAppUnlock === 'true');
    if (requireOn) {
      if (plain.length < 4) {
        return { success: false, error: '×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 4 ×ª×•×•×™×' };
      }
      var hash = hashAppLoginPassword(plain);
      props.setProperty(APP_LOGIN_PROP_HASH, hash);
      props.setProperty(APP_LOGIN_PROP_REQUIRED, 'true');
      Logger.log('×¡×™×¡××ª ×›× ×™×¡×” ×œ×ª×•×›× ×” ×”×•×’×“×¨×” (×“×¨×™×©×” ×‘××¡×š ×”×›× ×™×¡×”: ×›×Ÿ)');
      return { success: true, message: '×”×¡×™×¡××” × ×©××¨×” ×‘×”×¦×œ×—×” ×‘×¦×“ ×©×¨×ª' };
    }
    if (plain.length >= 4) {
      var hash = hashAppLoginPassword(plain);
      props.setProperty(APP_LOGIN_PROP_HASH, hash);
    } else {
      props.deleteProperty(APP_LOGIN_PROP_HASH);
    }
    props.setProperty(APP_LOGIN_PROP_REQUIRED, 'false');
    Logger.log('×¡×™×¡××ª ×›× ×™×¡×” ×œ×ª×•×›× ×” â€“ ×“×¨×™×©×” ×‘××¡×š ×”×›× ×™×¡×” ×›×•×‘×ª×”');
    return { success: true, message: '×”×’×“×¨×•×ª ×›× ×™×¡×” ×¢×•×“×›× ×•' };
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-setAppLoginPasswordHandler: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * POST: ××™××•×ª ×¡×™×¡××” ×©× ×–× ×” ×‘××¡×š ×”×›× ×™×¡×”
 * @param {string} password - ×¡×™×¡××” ×©×”××©×ª××© ×”×–×™×Ÿ
 */
function verifyAppLoginPasswordHandler(password) {
  try {
    var props = PropertiesService.getScriptProperties();
    var storedHash = props.getProperty(APP_LOGIN_PROP_HASH);
    if (!storedHash) {
      return { success: false, error: '×œ× ×”×•×’×“×¨×” ×¡×™×¡××” ×‘×©×¨×ª' };
    }
    var plain = (password && typeof password === 'string') ? password.trim() : '';
    var inputHash = hashAppLoginPassword(plain);
    var ok = inputHash.length > 0 && inputHash === storedHash;
    return { success: ok };
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-verifyAppLoginPasswordHandler: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// *****************************************************************************
// *** ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª â€“ getHistory / addHistory ***
// *****************************************************************************

/**
 * POST: ×”×•×¡×¤×ª ×¨×©×•××” ×œ×”×™×¡×˜×•×¨×™×”
 * @param {Object} entry - ××•×‘×™×™×§×˜ ×¢×: actionType, entityName, details, amount, source, timestamp, computerName, computerId
 */
function addHistoryHandler(entry) {
  try {
    if (!entry) {
      return { success: false, error: '×—×¡×¨×” ×¨×©×•××” ×œ×”×•×¡×¤×”' };
    }
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.HISTORY);
    if (!sheet) {
      return { success: false, error: '×’×™×œ×™×•×Ÿ ×”×™×¡×˜×•×¨×™×” ×œ× ×§×™×™×' };
    }
    var ts = entry.timestamp || new Date().toISOString();
    var d = new Date(ts);
    var dateStr = Utilities.formatDate(d, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    var timeStr = Utilities.formatDate(d, Session.getScriptTimeZone(), 'HH:mm');
    var row = [
      ts,
      dateStr,
      timeStr,
      entry.actionType || '',
      entry.entityName || '',
      entry.details || '',
      entry.amount !== undefined && entry.amount !== null ? entry.amount : '',
      entry.source || '',
      entry.computerName || ''
    ];
    sheet.appendRow(row);
    Logger.log('×”×™×¡×˜×•×¨×™×” × ×•×¡×¤×”: ' + (entry.entityName || '') + ' ' + dateStr + ' ' + timeStr);
    return { success: true, message: '× ×©××¨' };
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-addHistoryHandler: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * GET: ×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×” ×¢× ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š, ××§×•×¨ ×•×¡×•×’ ×¤×¢×•×œ×”
 * @param {Object} params - startDate, endDate, source, actionType
 */
function getHistoryHandler(params) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.HISTORY);
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, history: [] };
    }
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var startDate = (params.startDate || '').toString().trim();
    var endDate = (params.endDate || '').toString().trim();
    var sourceFilter = (params.source || '').toString().trim();
    var actionFilter = (params.actionType || '').toString().trim();
    var history = [];
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var rec = {
        timestamp: row[0],
        date: row[1],
        time: row[2],
        actionType: row[3],
        entityName: row[4],
        details: row[5],
        amount: row[6],
        source: row[7],
        computerName: row[8]
      };
      if (startDate && rec.date < startDate) continue;
      if (endDate && rec.date > endDate) continue;
      if (sourceFilter && rec.source !== sourceFilter) continue;
      if (actionFilter && rec.actionType !== actionFilter) continue;
      history.push(rec);
    }
    return { success: true, history: history };
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-getHistoryHandler: ' + error.toString());
    return { success: false, error: error.toString(), history: [] };
  }
}

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª PropertiesService (×œ×©×™××•×© ×¢× storageSetItem/storageGetItem) ***
// *****************************************************************************

/**
 * ×©××™×¨×ª ×¢×¨×š ×‘-PropertiesService
 * @param {String} key - ××¤×ª×—
 * @param {String} value - ×¢×¨×š (JSON string ××• string ×¨×’×™×œ)
 */
function storageSetItemHandler(key, value) {
  try {
    if (!key) {
      return { success: false, error: 'Missing key parameter' };
    }
    
    var props = PropertiesService.getScriptProperties();
    props.setProperty(key, value);
    
    Logger.log('× ×©××¨ ×‘-PropertiesService: ' + key + ' (××•×¨×š: ' + value.length + ')');
    return { success: true, message: '× ×©××¨ ×‘×”×¦×œ×—×”' };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×” ×‘-PropertiesService: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ×˜×¢×™× ×ª ×¢×¨×š ×-PropertiesService
 * @param {String} key - ××¤×ª×—
 */
function storageGetItemHandler(key) {
  try {
    if (!key) {
      return { success: false, error: 'Missing key parameter', value: null };
    }
    
    var props = PropertiesService.getScriptProperties();
    var value = props.getProperty(key);
    
    if (value === null) {
      return { success: true, value: null, message: '×œ× × ××¦× ×¢×¨×š' };
    }
    
    Logger.log('× ×˜×¢×Ÿ ×-PropertiesService: ' + key + ' (××•×¨×š: ' + value.length + ')');
    return { success: true, value: value };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×˜×¢×™× ×” ×-PropertiesService: ' + error.toString());
    return { success: false, error: error.toString(), value: null };
  }
}

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×™×ª ×‘×“×™×§×” ***
// *****************************************************************************

function testConnection() {
  Logger.log('=== ×‘×“×™×§×ª ×—×™×‘×•×¨ ===');
  
  // ×‘×“×™×§×ª ×’×™×œ×™×•×Ÿ
  try {
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    Logger.log('âœ… ×’×™×œ×™×•×Ÿ × ×¤×ª×— ×‘×”×¦×œ×—×”: ' + ss.getName());
  } catch (e) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª ×’×™×œ×™×•×Ÿ: ' + e.message);
    return { success: false, error: '×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××ª ×”×’×™×œ×™×•×Ÿ' };
  }
  
  // ×‘×“×™×§×ª × ×“×¨×™× ×¤×œ×•×¡
  var nedarimResult = getNedarimTotalDonations();
  Logger.log('× ×“×¨×™× ×¤×œ×•×¡: ' + JSON.stringify(nedarimResult));
  
  // ×‘×“×™×§×ª × ×ª×•× ×™×
  var data = getAllData();
  Logger.log('××ª×¨×™××™×: ' + (data.donors ? data.donors.length : 0));
  Logger.log('×§×‘×•×¦×•×ª: ' + (data.groups ? data.groups.length : 0));
  
  return {
    success: true,
    spreadsheet: ss.getName(),
    nedarimPlus: nedarimResult,
    donorsCount: data.donors ? data.donors.length : 0,
    groupsCount: data.groups ? data.groups.length : 0
  };
}
