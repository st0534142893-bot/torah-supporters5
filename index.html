/**
 * ×§×•×“ Google Apps Script ×œ×¡× ×›×¨×•×Ÿ ×“×•-×›×™×•×•× ×™ ×¢× ×ª×•×›× ×ª ×§××¤×™×™×Ÿ ×¤×•×¨×™×
 * ×›×•×œ×œ ×—×™×‘×•×¨ ×××•×‘×˜×— ×œ× ×“×¨×™× ×¤×œ×•×¡
 * 
 * ========== ×”×•×¨××•×ª ×”×ª×§× ×” ==========
 * 
 * 1. ×¤×ª×— ××ª ×”×’×œ×™×•×Ÿ ×”××œ×§×˜×¨×•× ×™ ×©×œ×š ×‘×’×•×’×œ
 * 2. ×œ×—×¥ ×¢×œ "×”×¨×—×‘×•×ª" (Extensions) -> "Apps Script"
 * 3. ××—×§ ××ª ×›×œ ×”×§×•×“ ×©×™×© ×©× ×•×”×“×‘×§ ××ª ×”×§×•×“ ×”×–×” ×‘××§×•×
 * 4. ×©× ×” ××ª SPREADSHEET_ID ×œ××–×”×” ×©×œ ×”×’×œ×™×•×Ÿ ×©×œ×š (××•×¤×™×¢ ×‘-URL)
 * 5. ×©× ×” ××ª ×”×’×“×¨×•×ª NEDARIM_CONFIG ×œ××¡×¤×¨×™× ×©×œ×š
 * 6. ×œ×—×¥ ×¢×œ "×¤×¨×™×¡×”" (Deploy) -> "×¤×¨×™×¡×” ×—×“×©×”" (New deployment)
 * 7. ×‘×—×¨ ×¡×•×’: "××¤×œ×™×§×¦×™×™×ª ××™× ×˜×¨× ×˜"
 * 8. ×”×’×“×¨ "×”×¤×¢×œ ×›": ×× ×™ (Me) | "×œ××™ ×™×© ×’×™×©×”": ×›×œ ××—×“ (Anyone)
 * 9. ×œ×—×¥ "×¤×¨×•×¡" ×•×”×¢×ª×§ ××ª ×”-URL ×©××ª×§×‘×œ
 * 
 * =====================================
 */

// âš ï¸ ×©× ×” ××ª ×”××–×”×” ×”×–×” ×œ××–×”×” ×©×œ ×”×’×œ×™×•×Ÿ ×©×œ×š!
const SPREADSHEET_ID = '1YI6XQZObSP1vfhIVh9wXYtIufM20PFjIGGM9rB-_rc8';

// *****************************************************************************
// *** ×”×’×“×¨×•×ª × ×“×¨×™× ×¤×œ×•×¡ - ×¡×•×“×™! ***
// *****************************************************************************
const NEDARIM_CONFIG = {
  MOSAD_ID: '1000642',
  MATCHING_ID: '715',
  API_PASSWORD: 'ep348',
  API_URL: 'https://matara.pro/nedarimplus/Reports/Manage3.aspx',
  ONLINE_API_URL: 'https://www.matara.pro/nedarimplus/online/Files/Manage.aspx',
  MATCH_PLUS_API_URL: 'https://www.matara.pro/nedarimplus/V6/MatchPlus.aspx'
};

// ×©××•×ª ×”×’×™×œ×™×•× ×•×ª
const SHEET_NAMES = {
  DONORS: '××ª×¨×™××™×',
  GROUPS: '×§×‘×•×¦×•×ª',
  SETTINGS: '×”×’×“×¨×•×ª'
};

// ========== ××‘× ×” ×¢××•×“×•×ª ×¤×©×•×˜ ×•×‘×¨×•×¨ ==========
// ×¢××•×“×•×ª ×œ××ª×¨×™××™×
const DONOR_COLUMNS = [
  'id',              // ××–×”×” ×™×™×—×•×“×™
  'name',            // ×©× ××œ× (××§×•×¨×™)
  'displayName',     // ×©× ×ª×¦×•×’×” (××¤×©×¨ ×œ×¢×¨×•×š)
  'groupId',         // ××–×”×” ×§×‘×•×¦×”
  'groupName',       // ×©× ×”×§×‘×•×¦×” (×œ× ×•×—×•×ª)
  'amount',          // ×¡×›×•× ×©×’×•×™×¡
  'personalGoal',    // ×™×¢×“ ××™×©×™
  'source',          // ××§×•×¨: nedarim_plus / manual
  'nedarimMatrimId', // ××¡×¤×¨ ××ª×¨×™× ×‘× ×“×¨×™× ×¤×œ×•×¡
  'createdAt',       // ×ª××¨×™×š ×™×¦×™×¨×”
  'updatedAt'        // ×ª××¨×™×š ×¢×“×›×•×Ÿ
];

// ×¢××•×“×•×ª ×œ×§×‘×•×¦×•×ª
const GROUP_COLUMNS = [
  'id',              // ××–×”×” ×™×™×—×•×“×™
  'name',            // ×©× ×”×§×‘×•×¦×”
  'goal',            // ×™×¢×“ ×”×§×‘×•×¦×”
  'orderNumber',     // ×¡×“×¨ ×‘×ª×¦×•×’×”
  'showInLiveView',  // ×”×× ×œ×”×¦×™×’ ×‘×œ×™×™×‘
  'createdAt',       // ×ª××¨×™×š ×™×¦×™×¨×”
  'updatedAt'        // ×ª××¨×™×š ×¢×“×›×•×Ÿ
];

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª HTTP ×¨××©×™×•×ª ***
// *****************************************************************************

function doGet(e) {
  var output;
  
  try {
    var action = e && e.parameter ? e.parameter.action : '';
    
    switch(action) {
      // ×‘×“×™×§×ª ×—×™×‘×•×¨
      case 'ping':
        output = { success: true, message: '×”×—×™×‘×•×¨ ×ª×§×™×Ÿ', timestamp: new Date().toISOString() };
        break;
        
      // ×¤×¢×•×œ×•×ª × ×“×¨×™× ×¤×œ×•×¡
      case 'getNedarimTotal':
        output = getNedarimTotalDonations();
        break;
      case 'searchNedarimRecruiters':
        var searchTerm = e && e.parameter ? e.parameter.search : '';
        output = searchNedarimRecruiters(searchTerm);
        break;
      case 'getPublicConfig':
        output = { success: true, mosadId: NEDARIM_CONFIG.MOSAD_ID, matchingId: NEDARIM_CONFIG.MATCHING_ID };
        break;
        
      // ×¤×¢×•×œ×•×ª ×¡× ×›×¨×•×Ÿ
      case 'getDonors':
        output = getAllDonors();
        break;
      case 'getGroups':
        output = getAllGroups();
        break;
      case 'getSettings':
        output = getAllSettings();
        break;
      case 'getAll':
        output = getAllData();
        break;
      case 'syncNedarimFromSheet':
        output = syncNedarimFromSheet();
        break;
        
      default:
        output = { success: false, error: '×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ' + action };
    }
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-doGet: ' + error.toString());
    output = { success: false, error: error.toString() };
  }
  
  return ContentService.createTextOutput(JSON.stringify(output))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var output;
  
  try {
    var requestData = {};
    
    if (e && e.postData && e.postData.contents) {
      try {
        requestData = JSON.parse(e.postData.contents);
      } catch (parseError) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: '×©×’×™××” ×‘×¤×¨×¡×•×¨ JSON'
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    var action = requestData.action || '';
    
    switch(action) {
      case 'saveDonors':
        output = saveDonors(requestData.donors, requestData.groups);
        break;
      case 'saveGroups':
        output = saveGroups(requestData.groups);
        break;
      case 'saveSettings':
        output = saveSettings(requestData.settings);
        break;
      case 'saveAll':
        output = saveAllData(requestData);
        break;
      case 'updateNedarimAmount':
        // ×¢×“×›×•×Ÿ ×¡×›×•× ×‘× ×“×¨×™× ×¤×œ×•×¡ (×¨×§ ×¤×¨××˜×¨×™× ×‘×¡×™×¡×™×™×, ×œ×œ× MatchingId)
        output = updateNedarimAmount(requestData);
        break;
      case 'syncNedarimFromSheet':
        // ×¡× ×›×¨×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡ ××”×’×œ×™×•×Ÿ - ×§×•×¨× ××”×’×œ×™×•×Ÿ ×•××¢×“×›×Ÿ ××ª × ×“×¨×™× ×¤×œ×•×¡
        output = syncNedarimFromSheet();
        break;
      case 'storageSetItem':
        // ×©××™×¨×ª ×¢×¨×š ×‘-PropertiesService (×œ×©×™××•×© ×¢× storageSetItem)
        output = storageSetItemHandler(requestData.key, requestData.value);
        break;
      case 'storageGetItem':
        // ×˜×¢×™× ×ª ×¢×¨×š ×-PropertiesService (×œ×©×™××•×© ×¢× storageGetItem)
        output = storageGetItemHandler(requestData.key);
        break;
      default:
        output = { success: false, error: '×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ' + action };
    }
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘-doPost: ' + error.toString());
    output = { success: false, error: error.toString() };
  }
  
  return ContentService.createTextOutput(JSON.stringify(output))
    .setMimeType(ContentService.MimeType.JSON);
}

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª × ×“×¨×™× ×¤×œ×•×¡ ***
// *****************************************************************************

/**
 * ×§×‘×œ×ª ×¡×›×•× ×ª×¨×•××•×ª ×›×•×œ×œ ×× ×“×¨×™× ×¤×œ×•×¡
 * ××—×©×‘ ××ª ×”×¡×›×•× ×”×××™×ª×™ ××›×œ ×”××ª×¨×™××™×
 */
function getNedarimTotalDonations() {
  try {
    var totalFromRecruiters = 0;
    var goalFromAPI = 0;
    
    // × ×™×¡×™×•×Ÿ 1: ×§×‘×œ×ª ×”×™×¢×“ ×-ShowGoal API
    Logger.log('×× ×¡×” ×œ×§×‘×œ ×™×¢×“ ×-ShowGoal API...');
    try {
      // × ×™×¡×™×•×Ÿ ×¢× GoalId
      var url1 = NEDARIM_CONFIG.MATCH_PLUS_API_URL + 
        '?Action=ShowGoal&MosadId=' + NEDARIM_CONFIG.MOSAD_ID + 
        '&GoalId=' + NEDARIM_CONFIG.MATCHING_ID;
      
      var response1 = UrlFetchApp.fetch(url1, { method: 'GET', muteHttpExceptions: true });
      
      if (response1.getResponseCode() === 200) {
        var responseText1 = response1.getContentText();
        Logger.log('×ª×’×•×‘×” ×-ShowGoal (GoalId): ' + responseText1.substring(0, 200));
        
        try {
          var data = JSON.parse(responseText1);
          goalFromAPI = parseFloat(data.Goal) || parseFloat(data.TargetSum) || parseFloat(data.GoalAmount) || 0;
          
          // ×× ×™×© ×’× ×¡×›×•× ×ª×¨×•××•×ª - × ×©×ª××© ×‘×•
          var donatedFromAPI = parseFloat(data.Donated) || parseFloat(data.DSum) || parseFloat(data.TotalDonated) || parseFloat(data.DonatedAmount) || 0;
          if (donatedFromAPI >= 0 && goalFromAPI > 0) {
            Logger.log('×¡×›×•× ×-API: ' + donatedFromAPI + ', ×™×¢×“: ' + goalFromAPI);
            return { 
              success: true, 
              totalDonated: donatedFromAPI, 
              goal: goalFromAPI, 
              source: 'ShowGoal' 
            };
          }
        } catch (parseError) {
          Logger.log('×©×’×™××” ×‘×¤×¨×¡×•×¨ JSON ×-ShowGoal: ' + parseError.message);
        }
      }
      
      // × ×™×¡×™×•×Ÿ × ×•×¡×£ ×¢× MatchingId ×‘××§×•× GoalId
      var url2 = NEDARIM_CONFIG.MATCH_PLUS_API_URL + 
        '?Action=ShowGoal&MosadId=' + NEDARIM_CONFIG.MOSAD_ID + 
        '&MatchingId=' + NEDARIM_CONFIG.MATCHING_ID;
      
      var response2 = UrlFetchApp.fetch(url2, { method: 'GET', muteHttpExceptions: true });
      
      if (response2.getResponseCode() === 200) {
        var responseText2 = response2.getContentText();
        Logger.log('×ª×’×•×‘×” ×-ShowGoal (MatchingId): ' + responseText2.substring(0, 200));
        
        try {
          var data2 = JSON.parse(responseText2);
          var goal2 = parseFloat(data2.Goal) || parseFloat(data2.TargetSum) || parseFloat(data2.GoalAmount) || 0;
          var donated2 = parseFloat(data2.Donated) || parseFloat(data2.DSum) || parseFloat(data2.TotalDonated) || parseFloat(data2.DonatedAmount) || 0;
          
          if (goal2 > 0) {
            goalFromAPI = goal2;
          }
          
          if (donated2 >= 0 && goalFromAPI > 0) {
            Logger.log('×¡×›×•× ×-API (MatchingId): ' + donated2 + ', ×™×¢×“: ' + goalFromAPI);
            return { 
              success: true, 
              totalDonated: donated2, 
              goal: goalFromAPI, 
              source: 'ShowGoal-MatchingId' 
            };
          }
        } catch (parseError2) {
          Logger.log('×©×’×™××” ×‘×¤×¨×¡×•×¨ JSON ×-ShowGoal (MatchingId): ' + parseError2.message);
        }
      }
      
    } catch (e) {
      Logger.log('×©×’×™××” ×‘-ShowGoal: ' + e.message);
    }
    
    // × ×™×¡×™×•×Ÿ 2: ×—×™×©×•×‘ ×”×¡×›×•× ×”×××™×ª×™ ××›×œ ×”××ª×¨×™××™×
    Logger.log('××—×©×‘ ×¡×›×•× ×›×•×œ×œ ××›×œ ×”××ª×¨×™××™×...');
    
    var hebrewLetters = ['×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×›', '×œ', '×', '× ', '×¡', '×¢', '×¤', '×¦', '×§', '×¨', '×©', '×ª'];
    var allRecruiters = {};
    
    // ×—×™×¤×•×© ×¨×™×§ ×§×•×“×
    try {
      var emptyResult = searchNedarimRecruiters('');
      if (emptyResult && emptyResult.success && emptyResult.recruiters) {
        emptyResult.recruiters.forEach(function(r) {
          var id = r.Id || r.MatrimId || r.Name;
          if (id) allRecruiters[id] = r;
        });
        Logger.log('×—×™×¤×•×© ×¨×™×§: ' + emptyResult.recruiters.length + ' ××ª×¨×™××™×');
      }
    } catch (e) {
      Logger.log('×©×’×™××” ×‘×—×™×¤×•×© ×¨×™×§: ' + e.message);
    }
    
    // ×—×™×¤×•×© ×œ×¤×™ ××•×ª×™×•×ª ×¢×‘×¨×™×•×ª
    for (var i = 0; i < hebrewLetters.length; i++) {
      var letter = hebrewLetters[i];
      try {
        var result = searchNedarimRecruiters(letter);
        if (result && result.success && result.recruiters) {
          result.recruiters.forEach(function(r) {
            var id = r.Id || r.MatrimId || r.Name;
            if (id) allRecruiters[id] = r;
          });
        }
      } catch (e) {
        Logger.log('×©×’×™××” ×‘×—×™×¤×•×© ' + letter + ': ' + e.message);
      }
    }
    
    // ×—×™×©×•×‘ ×”×¡×›×•× ×”×›×•×œ×œ
    var recruitersArray = [];
    for (var key in allRecruiters) {
      if (allRecruiters.hasOwnProperty(key)) {
        recruitersArray.push(allRecruiters[key]);
      }
    }
    
    for (var j = 0; j < recruitersArray.length; j++) {
      var r = recruitersArray[j];
      var amount = parseFloat(r.Cumule) || parseFloat(r.Amount) || parseFloat(r.Collected) || 0;
      totalFromRecruiters += amount;
    }
    
    Logger.log('×¡×›×•× ×›×•×œ×œ ×-' + recruitersArray.length + ' ××ª×¨×™××™×: ' + totalFromRecruiters);
    
    if (totalFromRecruiters > 0) {
      return {
        success: true,
        totalDonated: totalFromRecruiters,
        goal: goalFromAPI,
        source: 'Calculated-FromAllRecruiters',
        recruitersCount: recruitersArray.length
      };
    }
    
    return { success: false, error: '×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ × ×ª×•× ×™×', totalDonated: 0, goal: goalFromAPI };
    
  } catch (e) {
    Logger.log('×©×’×™××” ×›×œ×œ×™×ª: ' + e.message);
    return { success: false, error: e.message, totalDonated: 0, goal: 0 };
  }
}

/**
 * ×¢×“×›×•×Ÿ ×¡×›×•× ×‘× ×“×¨×™× ×¤×œ×•×¡ - ×¤×©×•×˜ ×•×™×©×™×¨
 * @param {Object} params - ×¤×¨××˜×¨×™×: matrimId (××¡×¤×¨ ××ª×¨×™×), amount (×©×™× ×•×™ ×‘×¡×›×•×), clientName, comments
 */
function updateNedarimAmount(params) {
  try {
    // ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
    if (!params.matrimId) {
      Logger.log('âŒ ×—×¡×¨ ××¡×¤×¨ ××ª×¨×™× (matrimId)');
      return { success: false, error: '×—×¡×¨ ××¡×¤×¨ ××ª×¨×™× (matrimId)' };
    }
    
    var validAmount = Math.round(parseFloat(params.amount) || 0);
    if (validAmount === 0) {
      Logger.log('âŒ ×¡×›×•× ×”×•× 0 - ×œ× ××¢×“×›×Ÿ');
      return { success: false, error: '×¡×›×•× ×—×™×™×‘ ×œ×”×™×•×ª ×©×•× ×” ×-0' };
    }
    
    // ×‘× ×™×™×ª ×¤×¨××˜×¨×™× ×œ×©×œ×™×—×” ×œ-API ×©×œ × ×“×¨×™× ×¤×œ×•×¡
    var formData = {
      'Action': 'MatchingOffLine',
      'MosadNumber': NEDARIM_CONFIG.MOSAD_ID, // 1000642
      'ApiPassword': NEDARIM_CONFIG.API_PASSWORD, // ep348
      'MatrimId': String(params.matrimId), // ××¡×¤×¨ ××ª×¨×™× - ×–×” ×”××–×”×” ×”×™×—×™×“!
      'ClientName': (params.clientName || '×ª×•×¨× ×× ×•× ×™××™').trim(),
      'Amount': String(validAmount), // ×”×©×™× ×•×™ ×‘×¡×›×•× (×—×™×•×‘×™ ××• ×©×œ×™×œ×™)
      'Comments': (params.comments || '').trim(),
      'AjaxId': Date.now().toString()
    };
    
    Logger.log('ğŸ“¤ ×©×•×œ×— ×¢×“×›×•×Ÿ ×œ× ×“×¨×™× ×¤×œ×•×¡:', {
      MatrimId: formData.MatrimId,
      Amount: formData.Amount,
      MosadNumber: formData.MosadNumber,
      ClientName: formData.ClientName.substring(0, 30)
    });
    
    // ×©×œ×™×—×” ×œ-API ×©×œ × ×“×¨×™× ×¤×œ×•×¡
    var response = UrlFetchApp.fetch(NEDARIM_CONFIG.API_URL, {
      method: 'POST',
      payload: formData,
      muteHttpExceptions: true
    });
    
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();
    
    Logger.log('ğŸ“¥ ×ª×’×•×‘×” ×× ×“×¨×™× ×¤×œ×•×¡:', {
      status: responseCode,
      responseLength: responseText.length,
      preview: responseText.substring(0, 200)
    });
    
    // ×× ×§×•×“ ×”×ª×’×•×‘×” ×”×•× 200, ×–×” ×”×¦×œ×—×”
    if (responseCode === 200) {
      // ×× ×¡×” ×œ×¤×¨×¡×¨ ×›-JSON
      try {
        var data = JSON.parse(responseText);
        if (data.Status === 'OK' || data.success === true) {
          Logger.log('âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×—:', data.Message || '×”×¡×›×•× ×¢×•×“×›×Ÿ');
          return { success: true, message: data.Message || '×”×¡×›×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' };
        }
        if (data.Status && data.Status !== 'OK') {
          Logger.log('âŒ ×©×’×™××” ×‘×ª×’×•×‘×”:', data.Message || data.error);
          return { success: false, error: data.Message || data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”' };
        }
        // ×× ××™×Ÿ Status ××‘×œ ×™×© JSON, ×–×” ×›× ×¨××” ×”×¦×œ×—×”
        Logger.log('âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×— (×œ×œ× Status):', responseText.substring(0, 100));
        return { success: true, message: '×”×¡×›×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' };
      } catch (parseError) {
        // ×× ×–×” ×œ× JSON, ×‘×•×“×§ ×× ×”×ª×’×•×‘×” ×§×¦×¨×” (×–×” ×‘×“×¨×š ×›×œ×œ ×”×¦×œ×—×”)
        var trimmed = responseText.trim();
        if (trimmed === '' || trimmed.length < 100) {
          Logger.log('âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×— (×ª×’×•×‘×” ×§×¦×¨×”):', trimmed);
          return { success: true, message: '×”×¡×›×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' };
        }
        // ×× ×”×ª×’×•×‘×” ××¨×•×›×”, ×–×” ×›× ×¨××” ×©×’×™××”
        Logger.log('âš ï¸ ×ª×’×•×‘×” ×œ× ×¦×¤×•×™×”:', trimmed.substring(0, 200));
        return { success: false, error: '×ª×’×•×‘×” ×œ× ×¦×¤×•×™×” ××”×©×¨×ª: ' + trimmed.substring(0, 150) };
      }
    } else {
      // ×§×•×“ ×œ× 200 = ×©×’×™××”
      Logger.log('âŒ ×©×’×™××ª ×©×¨×ª:', responseCode, responseText.substring(0, 200));
      return { 
        success: false, 
        error: '×©×’×™××ª ×©×¨×ª: ' + responseCode + ' - ' + responseText.substring(0, 150)
      };
    }
    
  } catch (err) {
    Logger.log('âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¢×“×›×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡: ' + err.toString());
    return { success: false, error: err.message || '×©×’×™××” ×œ× ×™×“×•×¢×”' };
  }
}

/**
 * ×¡× ×›×¨×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡ ××”×’×œ×™×•×Ÿ - ×§×•×¨× ××”×’×œ×™×•×Ÿ ×•××¢×“×›×Ÿ ××ª × ×“×¨×™× ×¤×œ×•×¡
 * ×¤×•× ×§×¦×™×” ×–×• ×§×•×¨××ª ××ª ×›×œ ×”××ª×¨×™× ××”×’×œ×™×•×Ÿ ×•××¢×“×›× ×ª ××ª × ×“×¨×™× ×¤×œ×•×¡ ×œ×¤×™ ××¡×¤×¨ ×”××ª×¨×™×
 */
function syncNedarimFromSheet() {
  try {
    Logger.log('ğŸ”„ ××ª×—×™×œ ×¡× ×›×¨×•×Ÿ × ×“×¨×™× ×¤×œ×•×¡ ××”×’×œ×™×•×Ÿ...');
    
    // ×§×•×¨× ××ª ×›×œ ×”××ª×¨×™× ××”×’×œ×™×•×Ÿ
    var donorsResult = getAllDonors();
    if (!donorsResult.success || !donorsResult.donors || donorsResult.donors.length === 0) {
      Logger.log('âš ï¸ ××™×Ÿ ××ª×¨×™××™× ×‘×’×œ×™×•×Ÿ');
      return { success: false, error: '××™×Ÿ ××ª×¨×™××™× ×‘×’×œ×™×•×Ÿ' };
    }
    
    var donors = donorsResult.donors;
    Logger.log('ğŸ“¥ × ×˜×¢× ×• ' + donors.length + ' ××ª×¨×™××™× ××”×’×œ×™×•×Ÿ');
    
    // ××•×©×š ××ª ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×× ×“×¨×™× ×¤×œ×•×¡ ×›×“×™ ×œ×—×©×‘ ×“×œ×ª×•×ª
    var matrimList = [];
    try {
      var searchResult = searchNedarimRecruiters('');
      if (searchResult && searchResult.success && searchResult.recruiters) {
        matrimList = searchResult.recruiters;
        Logger.log('ğŸ“Š ×§×™×‘×œ× ×• ' + matrimList.length + ' ××ª×¨×™××™× ×× ×“×¨×™× ×¤×œ×•×¡ ×œ×”×©×•×•××”');
      }
    } catch (error) {
      Logger.log('âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ××©×•×š × ×ª×•× ×™× ×× ×“×¨×™× ×¤×œ×•×¡ ×œ×”×©×•×•××”: ' + error.message);
    }
    
    // âš ï¸ ×—×©×•×‘: ×”×§×™×©×•×¨ ×”×•× ×œ×¤×™ ×”×©× ×‘×¢××•×“×” name (×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡), ×œ× ×œ×¤×™ ××¡×¤×¨ ××ª×¨×™×!
    // ×™×•×¦×¨ ××¤×” ×©×œ ×¡×›×•××™× ×× ×“×¨×™× ×¤×œ×•×¡ ×œ×¤×™ ×©× (×œ× ×œ×¤×™ ××¡×¤×¨ ××ª×¨×™×)
    var nedarimAmountsByNameMap = new Map();
    var nedarimMatrimIdsByNameMap = new Map(); // ××¤×” × ×•×¡×¤×ª ×œ××¡×¤×¨×™ ××ª×¨×™× ×œ×¤×™ ×©×
    matrimList.forEach(function(matrim) {
      var matrimName = (matrim.Name || matrim.name || '').trim();
      var matrimAmount = parseInt(matrim.Cumule) || parseInt(matrim.Amount) || 0;
      var matrimId = matrim.Id || matrim.MatrimId || matrim.id || null;
      if (matrimName) {
        nedarimAmountsByNameMap.set(matrimName, matrimAmount);
        if (matrimId !== null && matrimId !== undefined) {
          nedarimMatrimIdsByNameMap.set(matrimName, String(matrimId).trim());
        }
      }
    });
    
    // ××•×¦× ××ª×¨×™× ×©×™×© ×œ×”× ×©× ×•×”×¡×›×•× ×©×œ×”× ×©×•× ×” ×× ×“×¨×™× ×¤×œ×•×¡
    var donorsToUpdate = [];
    var updatedCount = 0;
    var skippedCount = 0;
    var failedCount = 0;
    var invalidMatrimIdCount = 0;
    
    for (var i = 0; i < donors.length; i++) {
      var donor = donors[i];
      
      // ×‘×•×“×§ ×× ×™×© ×©× (×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡)
      if (!donor.name) {
        skippedCount++;
        continue; // ××“×œ×’ ×¢×œ ××ª×¨×™× ×œ×œ× ×©×
      }
      
      var donorName = donor.name.trim(); // ×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡ (×¢××•×“×” name)
      var localAmount = donor.amount || 0;
      var nedarimAmount = nedarimAmountsByNameMap.get(donorName) || 0;
      var delta = localAmount - nedarimAmount;
      
      // ××•×¦× ××ª ××¡×¤×¨ ×”××ª×¨×™× ×œ×¤×™ ×”×©×
      var matrimIdStr = nedarimMatrimIdsByNameMap.get(donorName) || null;
      
      // ×× ××™×Ÿ ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ, ××“×œ×’
      if (!matrimIdStr || !/^\d+$/.test(matrimIdStr)) {
        invalidMatrimIdCount++;
        Logger.log('âš ï¸ ××ª×¨×™× ' + donorName + ' ×œ× × ××¦× ×œ×• ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ ×× ×“×¨×™× ×¤×œ×•×¡ - ××“×œ×’ ×¢×œ ×¢×“×›×•×Ÿ');
        skippedCount++;
        continue; // ××“×œ×’ ×¢×œ ××ª×¨×™× ×œ×œ× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ
      }
      
      // ×× ×™×© ×©×™× ×•×™, ××•×¡×™×£ ×œ×¨×©×™××” ×œ×¢×“×›×•×Ÿ
      if (Math.abs(delta) > 0) {
        donorsToUpdate.push({
          donor: donor,
          delta: delta,
          matrimId: matrimIdStr
        });
      } else {
        skippedCount++; // ××™×Ÿ ×©×™× ×•×™ - ××“×œ×’
      }
    }
    
    Logger.log('ğŸ“‹ × ××¦××• ' + donorsToUpdate.length + ' ××ª×¨×™××™× ×œ×¢×“×›×•×Ÿ ×‘× ×“×¨×™× ×¤×œ×•×¡');
    if (invalidMatrimIdCount > 0) {
      Logger.log('âš ï¸ ' + invalidMatrimIdCount + ' ××ª×¨×™××™× × ×“×œ×’×• ×›×™ ××™×Ÿ ×œ×”× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ');
    }
    
    // ××¢×“×›×Ÿ ×›×œ ××ª×¨×™× ×©×™×© ×œ×• ×©×™× ×•×™
    for (var j = 0; j < donorsToUpdate.length; j++) {
      var item = donorsToUpdate[j];
      var donor = item.donor;
      var delta = item.delta;
      var matrimId = item.matrimId;
      
      var donorName = donor.name || donor.displayName || '×ª×•×¨× ×× ×•× ×™××™'; // ×”×©× ×”××§×•×¨×™ ×× ×“×¨×™× ×¤×œ×•×¡ (×¢××•×“×” name)
      // ×§×•×¨× ××ª ×”×§×‘×•×¦×•×ª ××”×’×œ×™×•×Ÿ
      var groupsResult = getAllGroups();
      var groups = groupsResult.groups || [];
      var group = groups.find(function(g) { return g.id === donor.groupId; });
      var groupName = group ? group.name : '';
      var clientName = groupName ? donorName + ' - ' + groupName : donorName;
      
      // ××¢×“×›×Ÿ ××ª ××¡×¤×¨ ×”××ª×¨×™× ×× ×”×•× ×œ× ×ª×§×™×Ÿ ××• ×—×¡×¨
      if (donor.nedarimMatrimId !== matrimId) {
        var oldMatrimId = donor.nedarimMatrimId;
        donor.nedarimMatrimId = matrimId;
        Logger.log('âœ… ×¢×•×“×›×Ÿ ××¡×¤×¨ ××ª×¨×™× ×œ××ª×¨×™× ' + donorName + ': ' + (oldMatrimId || '×œ×œ×') + ' â†’ ' + matrimId);
      }
      
      Logger.log('ğŸ”„ ××¢×“×›×Ÿ ××ª×¨×™× ' + donorName + ' (××¡×¤×¨ ××ª×¨×™×: ' + matrimId + '): ×“×œ×ª×” = ' + delta);
      
      try {
        var updateResult = updateNedarimAmount({
          matrimId: matrimId,
          amount: delta,
          clientName: clientName,
          comments: '×¢×“×›×•×Ÿ ××”×’×œ×™×•×Ÿ - ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™ (×§×™×©×•×¨ ×œ×¤×™ ×©×)'
        });
        
        if (updateResult && updateResult.success) {
          updatedCount++;
          Logger.log('âœ… ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”: ' + donorName + ' (××¡×¤×¨ ××ª×¨×™×: ' + matrimId + ')');
        } else {
          failedCount++;
          Logger.log('âŒ × ×›×©×œ: ' + donorName + ' (××¡×¤×¨ ××ª×¨×™×: ' + matrimId + ') - ' + (updateResult.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
        }
        
        // ×××ª×™×Ÿ ×§×¦×ª ×‘×™×Ÿ ×¢×“×›×•× ×™× ×›×“×™ ×œ× ×œ×”×¢××™×¡ ×¢×œ ×”×©×¨×ª
        Utilities.sleep(500);
      } catch (error) {
        failedCount++;
        Logger.log('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ' + donorName + ': ' + error.message);
      }
    }
    
    // ×©×•××¨ ××ª ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ (×¢× ××¡×¤×¨×™ ×”××ª×¨×™× ×”××¢×•×“×›× ×™×)
    if (donorsToUpdate.length > 0) {
      try {
        var groupsResult = getAllGroups();
        var groups = groupsResult.groups || [];
        var saveResult = saveDonors(donors, groups);
        if (saveResult && saveResult.success) {
          Logger.log('âœ… × ×©××¨×• ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ');
        } else {
          Logger.log('âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ×©××•×¨ ××ª ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ: ' + (saveResult.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
        }
      } catch (error) {
        Logger.log('âš ï¸ ×©×’×™××” ×‘×©××™×¨×ª ×”××ª×¨×™× ×”××¢×•×“×›× ×™× ×—×–×¨×” ×œ×’×œ×™×•×Ÿ: ' + error.message);
      }
    }
    
    Logger.log('âœ… ×¡× ×›×¨×•×Ÿ ×”×•×©×œ×: ' + updatedCount + ' ×¢×•×“×›× ×•, ' + skippedCount + ' × ×“×œ×’×•, ' + failedCount + ' × ×›×©×œ×•');
    if (invalidMatrimIdCount > 0) {
      Logger.log('âš ï¸ ' + invalidMatrimIdCount + ' ××ª×¨×™××™× ×œ× ×¢×•×“×›× ×• ×›×™ ××™×Ÿ ×œ×”× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ - ×™×© ×œ×”×¨×™×¥ "×¡× ×›×¨×•×Ÿ ×ª×¨×•××•×ª" ×›×“×™ ×œ×§×©×¨ ××•×ª×');
    }
    
    var message = '×¡× ×›×¨×•×Ÿ ×”×•×©×œ×: ' + updatedCount + ' ×¢×•×“×›× ×•';
    if (failedCount > 0) {
      message += ', ' + failedCount + ' × ×›×©×œ×•';
    }
    if (invalidMatrimIdCount > 0) {
      message += ', ' + invalidMatrimIdCount + ' ×œ×œ× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ';
    }
    
    return {
      success: true,
      message: message,
      updated: updatedCount,
      skipped: skippedCount,
      failed: failedCount,
      invalidMatrimId: invalidMatrimIdCount,
      total: donorsToUpdate.length
    };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×¡× ×›×¨×•×Ÿ ××”×’×œ×™×•×Ÿ: ' + error.toString());
    return { success: false, error: error.message || '×©×’×™××” ×œ× ×™×“×•×¢×”' };
  }
}

/**
 * ×—×™×¤×•×© ××ª×¨×™××™× ×‘× ×“×¨×™× ×¤×œ×•×¡
 */
function searchNedarimRecruiters(searchTerm) {
  try {
    var url = NEDARIM_CONFIG.MATCH_PLUS_API_URL + 
      '?Action=SearchMatrim&Name=' + encodeURIComponent(searchTerm || '') + 
      '&MosadId=' + NEDARIM_CONFIG.MOSAD_ID;
    
    var response = UrlFetchApp.fetch(url, { method: 'GET', muteHttpExceptions: true });
    
    if (response.getResponseCode() === 200) {
      var data = JSON.parse(response.getContentText());
      
      if (Array.isArray(data)) {
        return { success: true, recruiters: data };
      } else if (data && data.Matrim) {
        return { success: true, recruiters: data.Matrim };
      } else if (data && data.recruiters) {
        return { success: true, recruiters: data.recruiters };
      }
      
      return { success: true, recruiters: [] };
    }
    
    return { success: false, error: '×©×’×™××ª ×©×¨×ª', recruiters: [] };
    
  } catch (e) {
    Logger.log('×©×’×™××” ×‘×—×™×¤×•×©: ' + e.message);
    return { success: false, error: e.message, recruiters: [] };
  }
}
// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª ×’×™×œ×™×•×Ÿ ***
// *****************************************************************************

/**
 * ×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª ×× ×œ× ×§×™×™××™×
 */
function ensureSheetsExist() {
  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  // ×’×™×œ×™×•×Ÿ ××ª×¨×™××™×
  var donorsSheet = ss.getSheetByName(SHEET_NAMES.DONORS);
  if (!donorsSheet) {
    donorsSheet = ss.insertSheet(SHEET_NAMES.DONORS);
    donorsSheet.getRange(1, 1, 1, DONOR_COLUMNS.length).setValues([DONOR_COLUMNS]);
    formatHeader(donorsSheet);
  } else {
    // ×‘×“×™×§×” ×•×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª
    var headers = donorsSheet.getRange(1, 1, 1, donorsSheet.getLastColumn()).getValues()[0];
    if (headers.length !== DONOR_COLUMNS.length || headers[0] !== DONOR_COLUMNS[0]) {
      donorsSheet.getRange(1, 1, 1, DONOR_COLUMNS.length).setValues([DONOR_COLUMNS]);
      formatHeader(donorsSheet);
    }
  }
  
  // ×’×™×œ×™×•×Ÿ ×§×‘×•×¦×•×ª
  var groupsSheet = ss.getSheetByName(SHEET_NAMES.GROUPS);
  if (!groupsSheet) {
    groupsSheet = ss.insertSheet(SHEET_NAMES.GROUPS);
    groupsSheet.getRange(1, 1, 1, GROUP_COLUMNS.length).setValues([GROUP_COLUMNS]);
    formatHeader(groupsSheet);
  }
  
  // ×’×™×œ×™×•×Ÿ ×”×’×“×¨×•×ª
  var settingsSheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
  if (!settingsSheet) {
    settingsSheet = ss.insertSheet(SHEET_NAMES.SETTINGS);
    settingsSheet.getRange(1, 1, 1, 2).setValues([['key', 'value']]);
    formatHeader(settingsSheet);
  }
  
  return { donors: donorsSheet, groups: groupsSheet, settings: settingsSheet };
}

function formatHeader(sheet) {
  var headerRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#D4AF37');
  headerRange.setFontColor('#FFFFFF');
  sheet.setFrozenRows(1);
}

// *****************************************************************************
// *** ×§×¨×™××ª × ×ª×•× ×™× ***
// *****************************************************************************

function getAllDonors() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.DONORS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      Logger.log('âš ï¸ ××™×Ÿ ××ª×¨×™××™× ×‘×’×œ×™×•×Ÿ (×”×’×œ×™×•×Ÿ ×¨×™×§ ××• ×œ× ×§×™×™×)');
      return { success: true, donors: [], donorsWithValidMatrimId: 0 };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    
    // ×‘×“×™×§×” ×©×”×¢××•×“×” nedarimMatrimId ×§×™×™××ª
    var hasNedarimMatrimIdColumn = false;
    var nedarimMatrimIdIndex = -1;
    for (var h = 0; h < headers.length; h++) {
      if (headers[h] === 'nedarimMatrimId') {
        hasNedarimMatrimIdColumn = true;
        nedarimMatrimIdIndex = h;
        break;
      }
    }
    
    // ×× ×”×¢××•×“×” ×œ× ×§×™×™××ª, × ×•×¡×™×£ ××•×ª×”
    if (!hasNedarimMatrimIdColumn) {
      Logger.log('âš ï¸ ×”×¢××•×“×” nedarimMatrimId ×œ× ×§×™×™××ª - ××•×¡×™×£ ××•×ª×”...');
      var lastCol = sheet.getLastColumn();
      sheet.getRange(1, lastCol + 1).setValue('nedarimMatrimId');
      formatHeader(sheet);
      // ×§×•×¨× ××—×“×© ××ª ×”× ×ª×•× ×™×
      data = sheet.getDataRange().getValues();
      headers = data[0];
      nedarimMatrimIdIndex = headers.length - 1;
      Logger.log('âœ… ×”×¢××•×“×” nedarimMatrimId × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
    }
    
    var donors = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var donor = {};
      
      for (var j = 0; j < headers.length; j++) {
        var key = headers[j];
        var value = row[j];
        
        if (!key) continue;
        
        if (key === 'amount' || key === 'personalGoal') {
          donor[key] = value ? Number(value) : 0;
        } else if (key === 'groupId') {
          donor[key] = value !== '' && value !== null ? value : '';
        } else if (key === 'nedarimMatrimId') {
          // ××¡×¤×¨ ××ª×¨×™× - ×©×•××¨ ×›×˜×§×¡×˜ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”××¡×¤×¨ ×”××§×•×¨×™
          donor[key] = value !== undefined && value !== null && value !== '' ? String(value).trim() : null;
        } else {
          donor[key] = value !== undefined && value !== null ? value : '';
        }
      }
      
      if (donor.id) {
        // ×‘×“×™×§×” ×©-nedarimMatrimId × ×˜×¢×Ÿ × ×›×•×Ÿ
        if (donor.nedarimMatrimId) {
          var matrimIdStr = String(donor.nedarimMatrimId).trim();
          // ×× ×–×” ×ª××¨×™×š, ××–×”×™×¨
          if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(matrimIdStr) || matrimIdStr.includes('T') || matrimIdStr.includes('Z')) {
            Logger.log('âš ï¸ ××ª×¨×™× ' + donor.name + ' ×™×© ×œ×• ××¡×¤×¨ ××ª×¨×™× ×œ× ×ª×§×™×Ÿ (×ª××¨×™×š): ' + matrimIdStr);
          }
        }
        donors.push(donor);
      }
    }
    
    // ×¡×¤×™×¨×ª ××ª×¨×™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ
    var donorsWithValidMatrimId = 0;
    for (var k = 0; k < donors.length; k++) {
      if (donors[k].nedarimMatrimId) {
        var idStr = String(donors[k].nedarimMatrimId).trim();
        if (/^\d+$/.test(idStr)) {
          donorsWithValidMatrimId++;
        }
      }
    }
    
    Logger.log('ğŸ“¥ × ×˜×¢× ×• ' + donors.length + ' ××ª×¨×™××™× ××”×’×œ×™×•×Ÿ');
    Logger.log('ğŸ“¥ ××ª×¨×™××™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ: ' + donorsWithValidMatrimId + ' ××ª×•×š ' + donors.length);
    
    if (donors.length > 0 && donorsWithValidMatrimId === 0) {
      Logger.log('âš ï¸ ××™×Ÿ ××ª×¨×™××™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ! ×™×© ×œ×§×©×¨ ××ª×¨×™××™× ×œ××¡×¤×¨ ××ª×¨×™× ×× ×“×¨×™× ×¤×œ×•×¡ ×“×¨×š ×›×¤×ª×•×¨ "×¡× ×›×¨×•×Ÿ ×ª×¨×•××•×ª"');
    }
    
    return { success: true, donors: donors, donorsWithValidMatrimId: donorsWithValidMatrimId };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘×§×¨×™××ª ××ª×¨×™××™×: ' + error.toString());
    return { success: false, error: error.toString(), donors: [], donorsWithValidMatrimId: 0 };
  }
}

function getAllGroups() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.GROUPS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, groups: [] };
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var groups = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var group = {};
      
      for (var j = 0; j < headers.length; j++) {
        var key = headers[j];
        var value = row[j];
        
        if (!key) continue;
        
        if (key === 'goal' || key === 'orderNumber') {
          group[key] = value ? Number(value) : 0;
        } else if (key === 'showInLiveView') {
          group[key] = value !== false && value !== 'false';
        } else {
          group[key] = value !== undefined && value !== null ? value : '';
        }
      }
      
      if (group.id) {
        groups.push(group);
      }
    }
    
    return { success: true, groups: groups };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×§×‘×•×¦×•×ª: ' + error.toString());
    return { success: false, error: error.toString(), groups: [] };
  }
}

function getAllSettings() {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return { success: true, settings: {} };
    }
    
    var data = sheet.getDataRange().getValues();
    var settings = {};
    
    for (var i = 1; i < data.length; i++) {
      var key = data[i][0];
      var value = data[i][1];
      
      if (key) {
        try {
          settings[key] = JSON.parse(value);
        } catch (e) {
          settings[key] = value;
        }
      }
    }
    
    return { success: true, settings: settings };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×”×’×“×¨×•×ª: ' + error.toString());
    return { success: false, error: error.toString(), settings: {} };
  }
}

function getAllData() {
  try {
    var donors = getAllDonors();
    var groups = getAllGroups();
    var settings = getAllSettings();
    
    return {
      success: true,
      donors: donors.donors || [],
      groups: groups.groups || [],
      settings: settings.settings || {},
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™×: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// *****************************************************************************
// *** ×©××™×¨×ª × ×ª×•× ×™× ***
// *****************************************************************************

function saveDonors(donors, groups) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.DONORS);
    
    // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™× - ××©×ª××© ×‘-clearContent ×‘××§×•× deleteRows ×›×“×™ ×œ×× ×•×¢ ×©×’×™××ª ×©×•×¨×•×ª ××•×§×¤××•×ª
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || DONOR_COLUMNS.length;
      sheet.getRange(2, 1, lastRow - 1, lastCol).clearContent();
    }
    
    if (!donors || donors.length === 0) {
      return { success: true, message: '××™×Ÿ ××ª×¨×™××™× ×œ×©××™×¨×”', count: 0 };
    }
    
    // ×‘× ×™×™×ª ××¤×ª ×§×‘×•×¦×•×ª (id -> name)
    var groupsMap = {};
    if (groups && groups.length > 0) {
      for (var g = 0; g < groups.length; g++) {
        groupsMap[groups[g].id] = groups[g].name || '';
      }
    } else {
      // ×× ××™×Ÿ ×§×‘×•×¦×•×ª, × × ×¡×” ×œ×§×¨×•× ××”×’×™×œ×™×•×Ÿ
      var groupsResult = getAllGroups();
      if (groupsResult.groups) {
        for (var g = 0; g < groupsResult.groups.length; g++) {
          groupsMap[groupsResult.groups[g].id] = groupsResult.groups[g].name || '';
        }
      }
    }
    
    // ×‘× ×™×™×ª ×©×•×¨×•×ª
    var rows = [];
    var now = new Date().toISOString();
    
    for (var i = 0; i < donors.length; i++) {
      var donor = donors[i];
      var row = [];
      
      for (var j = 0; j < DONOR_COLUMNS.length; j++) {
        var col = DONOR_COLUMNS[j];
        
        switch(col) {
          case 'groupName':
            row.push(groupsMap[donor.groupId] || '');
            break;
          case 'updatedAt':
            row.push(now);
            break;
          case 'createdAt':
            row.push(donor.createdAt || now);
            break;
          case 'source':
            row.push(donor.source || donor.fromNedarimPlus ? 'nedarim_plus' : 'manual');
            break;
          case 'nedarimMatrimId':
            // ××¡×¤×¨ ××ª×¨×™× - ×©×•××¨ ×›×˜×§×¡×˜ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”××¡×¤×¨ ×”××§×•×¨×™
            var matrimId = donor.nedarimMatrimId;
            var matrimIdStr = matrimId !== undefined && matrimId !== null && matrimId !== '' ? String(matrimId).trim() : '';
            
            // ×‘×•×“×§ ×× ×–×” ××¡×¤×¨ ×××™×ª×™ (×œ× ×ª××¨×™×š)
            if (matrimIdStr) {
              // ×× ×–×” ×ª××¨×™×š ××• ×œ× ××¡×¤×¨ ×ª×§×™×Ÿ, ×œ× ×©×•××¨ ××•×ª×•
              var isDate = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(matrimIdStr) || matrimIdStr.includes('T') || matrimIdStr.includes('Z');
              var isNumeric = /^\d+$/.test(matrimIdStr);
              
              if (isDate || !isNumeric) {
                Logger.log('âš ï¸ ××ª×¨×™× ' + donor.name + ' ×™×© ×œ×• ××¡×¤×¨ ××ª×¨×™× ×œ× ×ª×§×™×Ÿ (×ª××¨×™×š ××• ×œ× ××¡×¤×¨×™): ' + matrimIdStr + ' - ×œ× ×©×•××¨ ×œ×’×œ×™×•×Ÿ');
                row.push(''); // ×œ× ×©×•××¨ ×ª××¨×™×š ××• ××¡×¤×¨ ×œ× ×ª×§×™×Ÿ
              } else {
                // ×–×” ××¡×¤×¨ ×ª×§×™×Ÿ - ×©×•××¨ ××•×ª×•
                Logger.log('âœ… ×©×•××¨ ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ ×œ××ª×¨×™× ' + donor.name + ': ' + matrimIdStr);
                row.push(matrimIdStr);
              }
            } else {
              // ××™×Ÿ ××¡×¤×¨ ××ª×¨×™×
              row.push('');
            }
            break;
          default:
            var value = donor[col];
            row.push(value !== undefined && value !== null ? value : '');
        }
      }
      
      rows.push(row);
    }
    
    // ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, DONOR_COLUMNS.length).setValues(rows);
    }
    
    // ×‘×“×™×§×” ×›××” ××ª×¨×™× ×™×© ×œ×”× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ
    var donorsWithMatrimId = 0;
    for (var k = 0; k < donors.length; k++) {
      if (donors[k].nedarimMatrimId && String(donors[k].nedarimMatrimId).trim() !== '') {
        var matrimIdStr = String(donors[k].nedarimMatrimId).trim();
        var isNumeric = /^\d+$/.test(matrimIdStr);
        if (isNumeric) {
          donorsWithMatrimId++;
        }
      }
    }
    
    Logger.log('× ×©××¨×• ' + donors.length + ' ××ª×¨×™××™×');
    Logger.log('××ª×¨×™××™× ×¢× ××¡×¤×¨ ××ª×¨×™× ×ª×§×™×Ÿ: ' + donorsWithMatrimId + ' ××ª×•×š ' + donors.length);
    return { success: true, message: '× ×©××¨×• ' + donors.length + ' ××ª×¨×™××™×', count: donors.length, donorsWithMatrimId: donorsWithMatrimId };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ××ª×¨×™××™×: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveGroups(groups) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.GROUPS);
    
    // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™× - ××©×ª××© ×‘-clearContent ×‘××§×•× deleteRows
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || GROUP_COLUMNS.length;
      sheet.getRange(2, 1, lastRow - 1, lastCol).clearContent();
    }
    
    if (!groups || groups.length === 0) {
      return { success: true, message: '××™×Ÿ ×§×‘×•×¦×•×ª ×œ×©××™×¨×”', count: 0 };
    }
    
    // ×‘× ×™×™×ª ×©×•×¨×•×ª
    var rows = [];
    var now = new Date().toISOString();
    
    for (var i = 0; i < groups.length; i++) {
      var group = groups[i];
      var row = [];
      
      for (var j = 0; j < GROUP_COLUMNS.length; j++) {
        var col = GROUP_COLUMNS[j];
        
        switch(col) {
          case 'updatedAt':
            row.push(now);
            break;
          case 'createdAt':
            row.push(group.createdAt || now);
            break;
          case 'showInLiveView':
            row.push(group.showInLiveView !== false);
            break;
          default:
            var value = group[col];
            row.push(value !== undefined && value !== null ? value : '');
        }
      }
      
      rows.push(row);
    }
    
    // ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, GROUP_COLUMNS.length).setValues(rows);
    }
    
    Logger.log('× ×©××¨×• ' + groups.length + ' ×§×‘×•×¦×•×ª');
    return { success: true, message: '× ×©××¨×• ' + groups.length + ' ×§×‘×•×¦×•×ª', count: groups.length };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×§×‘×•×¦×•×ª: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveSettings(settings) {
  try {
    ensureSheetsExist();
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAMES.SETTINGS);
    
    // ××—×™×§×ª × ×ª×•× ×™× ×™×©× ×™× - ××©×ª××© ×‘-clearContent ×‘××§×•× deleteRows ×›×“×™ ×œ×× ×•×¢ ×©×’×™××ª ×©×•×¨×•×ª ××•×§×¤××•×ª
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      var lastCol = sheet.getLastColumn() || 2;
      sheet.getRange(2, 1, lastRow - 1, lastCol).clearContent();
    }
    
    if (!settings || Object.keys(settings).length === 0) {
      return { success: true, message: '××™×Ÿ ×”×’×“×¨×•×ª ×œ×©××™×¨×”', count: 0 };
    }
    
    // ×‘× ×™×™×ª ×©×•×¨×•×ª
    var rows = [];
    var keys = Object.keys(settings);
    
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      var value = settings[key];
      
      if (typeof value === 'object') {
        value = JSON.stringify(value);
      }
      
      rows.push([key, value]);
    }
    
    // ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, 2).setValues(rows);
    }
    
    Logger.log('× ×©××¨×• ' + keys.length + ' ×”×’×“×¨×•×ª');
    return { success: true, message: '× ×©××¨×• ' + keys.length + ' ×”×’×“×¨×•×ª', count: keys.length };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×”×’×“×¨×•×ª: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function saveAllData(data) {
  try {
    var results = {};
    
    // ×©×•××¨×™× ×§×‘×•×¦×•×ª ×§×•×“×
    if (data.groups) {
      results.groups = saveGroups(data.groups);
    }
    
    // ×©×•××¨×™× ××ª×¨×™××™× ×¢× ×”×§×‘×•×¦×•×ª
    if (data.donors) {
      results.donors = saveDonors(data.donors, data.groups);
    }
    
    // ×©×•××¨×™× ×”×’×“×¨×•×ª
    if (data.settings) {
      results.settings = saveSettings(data.settings);
    }
    
    return {
      success: true,
      results: results,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×ª ×›×œ ×”× ×ª×•× ×™×: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×•×ª PropertiesService (×œ×©×™××•×© ×¢× storageSetItem/storageGetItem) ***
// *****************************************************************************

/**
 * ×©××™×¨×ª ×¢×¨×š ×‘-PropertiesService
 * @param {String} key - ××¤×ª×—
 * @param {String} value - ×¢×¨×š (JSON string ××• string ×¨×’×™×œ)
 */
function storageSetItemHandler(key, value) {
  try {
    if (!key) {
      return { success: false, error: 'Missing key parameter' };
    }
    
    var props = PropertiesService.getScriptProperties();
    props.setProperty(key, value);
    
    Logger.log('× ×©××¨ ×‘-PropertiesService: ' + key + ' (××•×¨×š: ' + value.length + ')');
    return { success: true, message: '× ×©××¨ ×‘×”×¦×œ×—×”' };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×©××™×¨×” ×‘-PropertiesService: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ×˜×¢×™× ×ª ×¢×¨×š ×-PropertiesService
 * @param {String} key - ××¤×ª×—
 */
function storageGetItemHandler(key) {
  try {
    if (!key) {
      return { success: false, error: 'Missing key parameter', value: null };
    }
    
    var props = PropertiesService.getScriptProperties();
    var value = props.getProperty(key);
    
    if (value === null) {
      return { success: true, value: null, message: '×œ× × ××¦× ×¢×¨×š' };
    }
    
    Logger.log('× ×˜×¢×Ÿ ×-PropertiesService: ' + key + ' (××•×¨×š: ' + value.length + ')');
    return { success: true, value: value };
    
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×˜×¢×™× ×” ×-PropertiesService: ' + error.toString());
    return { success: false, error: error.toString(), value: null };
  }
}

// *****************************************************************************
// *** ×¤×•× ×§×¦×™×™×ª ×‘×“×™×§×” ***
// *****************************************************************************

function testConnection() {
  Logger.log('=== ×‘×“×™×§×ª ×—×™×‘×•×¨ ===');
  
  // ×‘×“×™×§×ª ×’×™×œ×™×•×Ÿ
  try {
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    Logger.log('âœ… ×’×™×œ×™×•×Ÿ × ×¤×ª×— ×‘×”×¦×œ×—×”: ' + ss.getName());
  } catch (e) {
    Logger.log('âŒ ×©×’×™××” ×‘×¤×ª×™×—×ª ×’×™×œ×™×•×Ÿ: ' + e.message);
    return { success: false, error: '×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××ª ×”×’×™×œ×™×•×Ÿ' };
  }
  
  // ×‘×“×™×§×ª × ×“×¨×™× ×¤×œ×•×¡
  var nedarimResult = getNedarimTotalDonations();
  Logger.log('× ×“×¨×™× ×¤×œ×•×¡: ' + JSON.stringify(nedarimResult));
  
  // ×‘×“×™×§×ª × ×ª×•× ×™×
  var data = getAllData();
  Logger.log('××ª×¨×™××™×: ' + (data.donors ? data.donors.length : 0));
  Logger.log('×§×‘×•×¦×•×ª: ' + (data.groups ? data.groups.length : 0));
  
  return {
    success: true,
    spreadsheet: ss.getName(),
    nedarimPlus: nedarimResult,
    donorsCount: data.donors ? data.donors.length : 0,
    groupsCount: data.groups ? data.groups.length : 0
  };
}
